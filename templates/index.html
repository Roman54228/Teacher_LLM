<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Prep - Telegram Mini App</title>
    
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        // Инициализация Яндекс.Метрики с webvisor и настройками для Telegram Mini App
        ym(103395184, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true,
            trackHash:true,
            params: {
                telegram_mini_app: true,
                app_version: "1.0"
            }
        });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/103395184" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Telegram WebApp initialization
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        
        // Yandex.Metrika events tracking functions
        function trackEvent(event, params = {}) {
            if (typeof ym !== 'undefined') {
                ym(103395184, 'reachGoal', event, params);
                console.log('Yandex.Metrika event:', event, params);
            }
        }
        
        function trackPageView(pageName) {
            if (typeof ym !== 'undefined') {
                ym(103395184, 'hit', window.location.pathname, {
                    title: pageName,
                    params: {
                        page_name: pageName,
                        telegram_user_id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'anonymous'
                    }
                });
                console.log('Yandex.Metrika page view:', pageName);
            }
        }
        
        function trackTestEvent(action, category, params = {}) {
            const eventName = `test_${action}`;
            trackEvent(eventName, {
                category: category,
                telegram_user_id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'anonymous',
                ...params
            });
        }
        
        // Debug Telegram WebApp
        console.log('Telegram WebApp initialized:', window.Telegram.WebApp);
        console.log('Init data:', window.Telegram.WebApp.initData);
        console.log('Init data unsafe:', window.Telegram.WebApp.initDataUnsafe);
        console.log('User data:', window.Telegram.WebApp.initDataUnsafe.user);
        
        // Prepare validation data for server
        function prepareTelegramValidationData() {
            const tgApp = window.Telegram.WebApp;
            if (!tgApp.initData) return null;
            
            const urlParams = new URLSearchParams(tgApp.initData);
            const hash = urlParams.get("hash");
            urlParams.delete("hash");
            urlParams.sort();
            
            let dataCheckString = "";
            for(const [key, value] of urlParams.entries()){
                dataCheckString += key+'='+value+'\n';
            }
            dataCheckString = dataCheckString.slice(0, -1);
            
            return {
                dataCheckString: dataCheckString,
                hash: hash,
                initData: tgApp.initData
            };
        }
        
        // Cookie utility function
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }
        
        // Show Telegram validation status
        function showTelegramValidationStatus() {
            const tgApp = window.Telegram.WebApp;
            const statusDiv = document.getElementById('telegram-validation-status');
            const textDiv = document.getElementById('validation-text');
            
            if (tgApp && tgApp.initDataUnsafe && tgApp.initDataUnsafe.user) {
                const user = tgApp.initDataUnsafe.user;
                const validationData = prepareTelegramValidationData();
                
                if (validationData && validationData.hash) {
                    textDiv.innerHTML = `User: ${user.username || user.first_name}, validation data ready!`;
                    statusDiv.style.background = '#e8f5e8';
                    statusDiv.style.color = '#2d5a2d';
                    statusDiv.style.border = '1px solid #4caf50';
                } else {
                    textDiv.innerHTML = `User: ${user.username || user.first_name}, no validation data`;
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    statusDiv.style.border = '1px solid #ffc107';
                }
                statusDiv.style.display = 'block';
            } else if (tgApp) {
                textDiv.innerHTML = 'Telegram WebApp detected, but no user data available';
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #dc3545';
                statusDiv.style.display = 'block';
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #F5E6D3 0%, #E8C4A0 30%, #D4A574 70%, #C8956D 100%);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            min-height: 100vh;
        }



        /* Современная навигационная панель */
        .navigation-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: #FF6B35;
            border-radius: 2px;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
            color: #5A4A3A;
        }

        .nav-label {
            font-size: 10px;
            color: #5A4A3A;
            font-weight: 500;
        }

        /* Статистическая панель */
        .stats-overview {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            text-align: center;
        }

        .stat-item {
            color: #5A4A3A;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #FF6B35;
            margin-bottom: 4px;
        }

        .stat-text {
            font-size: 11px;
            color: #8B7355;
        }

        /* Нижняя навигация */
        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 8px 16px 12px;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            display: none; /* Скрыто по умолчанию до авторизации */
        }

        .bottom-navigation.visible {
            display: block;
        }

        .bottom-nav-grid {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            max-width: 480px;
            margin: 0 auto;
            width: 100%;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            text-decoration: none;
            flex: 1;
            min-width: 60px;
            max-width: 80px;
        }

        .bottom-nav-item:hover {
            background: rgba(255, 107, 53, 0.1);
            transform: translateY(-2px);
        }

        .bottom-nav-item.active {
            background: rgba(255, 107, 53, 0.15);
        }

        .bottom-nav-item.active::after {
            content: '';
            position: absolute;
            top: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: #FF6B35;
            border-radius: 2px;
        }

        .bottom-nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            fill: #8B7355;
            transition: fill 0.3s ease;
        }

        .bottom-nav-item.active .bottom-nav-icon {
            fill: #FF6B35;
        }

        .bottom-nav-label {
            font-size: 10px;
            color: #8B7355;
            font-weight: 500;
            text-align: center;
            line-height: 1.2;
        }

        .bottom-nav-item.active .bottom-nav-label {
            color: #FF6B35;
            font-weight: 600;
        }

        /* Добавить отступ снизу для контента */
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding-bottom: 80px; /* Отступ для нижней навигации */
        }

        /* Стили для базы знаний */
        .knowledge-categories {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 0 16px;
        }

        .knowledge-category {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .knowledge-category:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.2);
        }

        .knowledge-icon {
            font-size: 32px;
            min-width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 12px;
        }

        .knowledge-info {
            flex: 1;
        }

        .knowledge-info h3 {
            font-size: 16px;
            font-weight: 600;
            color: #5A4A3A;
            margin: 0 0 4px 0;
        }

        .knowledge-info p {
            font-size: 14px;
            color: #6B5B4F;
            margin: 0 0 8px 0;
            line-height: 1.4;
            font-weight: 500;
        }

        .knowledge-badge {
            background: rgba(255, 107, 53, 0.1);
            color: #FF6B35;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Стили для модульной структуры */
        .modules-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            padding: 0 16px;
        }

        .module-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .module-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.2);
        }

        .module-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--module-color, #FF6B35);
            border-radius: 20px 20px 0 0;
        }

        .module-header-info {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .module-icon {
            font-size: 36px;
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 16px;
        }

        .module-info h3 {
            font-size: 20px;
            font-weight: 700;
            color: #5A4A3A;
            margin: 0 0 4px 0;
        }

        .module-info p {
            font-size: 14px;
            color: #8B7355;
            margin: 0;
            line-height: 1.4;
        }

        .module-stats {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }

        .module-stat {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 12px;
            text-align: center;
            flex: 1;
        }

        .module-stat-number {
            font-size: 18px;
            font-weight: 700;
            color: #FF6B35;
            margin-bottom: 2px;
        }

        .module-stat-label {
            font-size: 11px;
            color: #8B7355;
            font-weight: 500;
        }

        /* Topics view */
        .topics-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            padding: 0 16px;
        }

        .topic-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .topic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.2);
        }

        .topic-icon {
            font-size: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .topic-info {
            flex: 1;
        }

        .topic-info h4 {
            font-size: 16px;
            font-weight: 600;
            color: #5A4A3A;
            margin: 0 0 4px 0;
        }

        .topic-info p {
            font-size: 14px;
            color: #8B7355;
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .topic-meta {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .topic-badge {
            background: rgba(255, 107, 53, 0.1);
            color: #FF6B35;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        .topic-difficulty {
            font-size: 12px;
            color: #8B7355;
        }

        .topic-difficulty.beginner { color: #30D158; }
        .topic-difficulty.intermediate { color: #FF9500; }
        .topic-difficulty.advanced { color: #FF3B30; }

        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            margin: 0 16px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #5A4A3A;
            font-size: 14px;
            font-weight: 500;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .module-header {
            text-align: center;
            padding: 20px 16px;
            margin-bottom: 20px;
        }

        .module-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: #5A4A3A;
            margin: 0 0 8px 0;
        }

        .module-header p {
            font-size: 16px;
            color: #8B7355;
            margin: 0;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
        }

        .stats-card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stats-row:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .category-card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .category-card:hover {
            background: var(--tg-theme-section-bg-color, #e9ecef);
        }

        .category-card.active {
            border-color: var(--tg-theme-button-color, #FF6B35);
            background: var(--tg-theme-button-color, #FF6B35);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .category-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .category-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .category-description {
            font-size: 11px;
            opacity: 0.6;
            margin-bottom: 8px;
        }

        .category-stats {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .question-card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .question-number {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .question-progress {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .question-text {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .question-text .code-block {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .question-text code {
            background: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }

        .options-list {
            list-style: none;
        }

        .option-item {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 2px solid var(--tg-theme-section-separator-color, #e5e5ea);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-item:hover {
            border-color: var(--tg-theme-button-color, #FF6B35);
        }

        .option-item.selected {
            border-color: var(--tg-theme-button-color, #FF6B35);
            background: var(--tg-theme-button-color, #FF6B35);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .option-item.correct {
            border-color: #34c759;
            background: #34c759;
            color: #ffffff;
        }

        .option-item.incorrect {
            border-color: #ff3b30;
            background: #ff3b30;
            color: #ffffff;
        }

        .buttons-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .buttons-container {
            margin-top: 16px;
        }

        .buttons-row-main {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .buttons-row-helper {
            display: flex;
            gap: 8px;
        }

        .buttons-row-exit {
            display: flex;
            justify-content: center;
            margin-top: 12px;
        }

        .btn-exit {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: #ff3b30;
            min-width: 120px;
        }

        .btn-exit:hover {
            background: rgba(255, 59, 48, 0.2);
            border-color: #ff3b30;
        }

        /* Mobile responsive buttons */
        @media (max-width: 480px) {
            .buttons-row-main .btn,
            .buttons-row-helper .btn {
                flex: 1;
                font-size: 14px;
                padding: 10px 12px;
            }

            .btn-exit {
                width: 100%;
                font-size: 14px;
                padding: 10px 12px;
            }
        }

        @media (min-width: 481px) {
            .buttons-row-main {
                margin-bottom: 8px;
            }
            
            .buttons-row-helper {
                margin-bottom: 8px;
            }
            
            .buttons-row-exit {
                margin-top: 8px;
            }
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #FF6B35);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            color: var(--tg-theme-text-color, #000000);
        }

        .btn-outline {
            background: transparent;
            color: var(--tg-theme-button-color, #FF6B35);
            border: 2px solid var(--tg-theme-button-color, #FF6B35);
            font-weight: 500;
        }

        .btn-outline:hover {
            background: var(--tg-theme-button-color, #FF6B35);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hint-card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            border-left: 4px solid #ffc107;
        }

        .chat-container {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            margin-top: 16px;
            overflow: hidden;
        }

        .chat-header {
            background: var(--tg-theme-button-color, #FF6B35);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h4 {
            margin: 0;
            font-size: 14px;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 16px;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-message .code-block {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .chat-message .code-separator {
            border-top: 2px solid #e1e4e8;
            margin: 12px 0;
            padding-top: 12px;
        }

        .chat-message strong {
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
        }

        .chat-message em {
            font-style: italic;
            color: var(--tg-theme-hint-color, #666666);
        }

        .chat-message code {
            background: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            color: #d63384;
        }

        .quick-questions {
            padding: 12px 16px;
            border-bottom: 1px solid var(--tg-theme-section-separator-color, #e5e5ea);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quick-question-btn {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5ea);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
        }

        .quick-question-btn:hover {
            background: var(--tg-theme-button-color, #FF6B35);
            color: white;
        }

        .chat-message.user {
            background: var(--tg-theme-button-color, #FF6B35);
            color: white;
            margin-left: auto;
        }

        .chat-message.ai {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5ea);
        }

        .chat-input {
            display: flex;
            padding: 12px 16px;
            border-top: 1px solid var(--tg-theme-section-separator-color, #e5e5ea);
            gap: 8px;
        }

        .chat-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5ea);
            border-radius: 6px;
            font-size: 14px;
        }

        .chat-input button {
            padding: 8px 16px;
            background: var(--tg-theme-button-color, #FF6B35);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--tg-theme-section-separator-color, #e5e5ea);
            border-radius: 2px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--tg-theme-button-color, #FF6B35);
            transition: width 0.3s ease;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .hidden {
            display: none;
        }

        /* Loading animation styles */
        .loading-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            color: white;
            border-radius: 12px;
            margin: 10px 0;
            font-weight: 500;
            animation: pulse-glow 2s infinite;
            position: relative;
            z-index: 10;
        }

        .loading-indicator.show {
            display: flex;
        }

        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dots .dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: loading-pulse 1.4s infinite ease-in-out;
        }

        .loading-dots .dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots .dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dots .dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loading-pulse {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 107, 53, 0.3); }
            50% { box-shadow: 0 0 30px rgba(255, 107, 53, 0.6); }
        }

        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 6px;
            min-width: 60px;
            text-align: center;
        }

        .navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            border-top: 1px solid var(--tg-theme-section-separator-color, #e5e5ea);
            padding: 12px 16px;
            display: flex;
            gap: 8px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            color: var(--tg-theme-text-color, #000000);
        }

        .nav-btn.active {
            background: var(--tg-theme-button-color, #FF6B35);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .content {
            padding-bottom: 80px;
        }

        .welcome-section {
            margin-bottom: 24px;
        }

        .welcome-card {
            background: linear-gradient(135deg, var(--tg-theme-button-color, #FF6B35) 0%, #E55A2B 100%);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            color: white;
            margin-bottom: 24px;
        }

        .welcome-card h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .welcome-card p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .btn-large {
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            width: 100%;
            max-width: 280px;
        }

        /* New Design Styles */
        .app-header-new {
            background: linear-gradient(135deg, #FF6B35 0%, #E55A2B 100%);
            border-radius: 16px 16px 0 0;
            color: white;
            padding: 20px;
            margin-bottom: 0;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-info h1 {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
        }

        .user-level {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .header-stats {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-badge {
            background: #ff3b30;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .profile-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-card-new {
            background: linear-gradient(135deg, #FF6B35 0%, #00d4ff 100%);
            color: white;
            padding: 20px;
            border-radius: 0 0 16px 16px;
            margin-bottom: 24px;
        }

        .progress-stats {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stat-left, .stat-right {
            text-align: center;
            min-width: 80px;
        }

        .streak-count, .xp-count {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .streak-label, .xp-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .stat-center {
            flex: 1;
            margin: 0 20px;
        }

        .progress-bar-container {
            text-align: center;
        }

        .progress-bar-new {
            background: rgba(255, 255, 255, 0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill-new {
            background: white;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            font-weight: 600;
        }

        .action-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .action-card {
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .action-card.primary {
            background: #34c759;
            color: white;
        }

        .action-card.secondary {
            background: #FF6B35;
            color: white;
        }

        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .card-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Skills Assessment Cards */
        .skills-grid, .modules-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        /* Module Cards */
        .module-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .module-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            border-color: var(--module-color, #FF6B35);
        }

        .module-header-info {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 8px;
        }

        .module-icon {
            font-size: 24px;
            line-height: 1;
        }

        .module-info h3 {
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0 0 4px 0;
            line-height: 1.2;
        }

        .module-info p {
            font-size: 11px;
            color: #8e8e93;
            margin: 0;
            line-height: 1.3;
        }

        .module-stats {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-top: 12px;
        }

        .module-stat {
            text-align: center;
            flex: 1;
        }

        .module-stat-number {
            font-size: 16px;
            font-weight: 700;
            color: var(--module-color, #FF6B35);
            margin-bottom: 2px;
        }

        .module-stat-label {
            font-size: 10px;
            color: #8e8e93;
            font-weight: 500;
        }

        /* Loading Message */
        .loading-message {
            text-align: center;
            padding: 40px 20px;
            color: #8e8e93;
            font-size: 14px;
            grid-column: 1 / -1;
        }

        .skill-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e5e5ea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .skill-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .skill-icon-container {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 24px;
        }

        .skill-icon-container.junior {
            background: linear-gradient(135deg, #FF6B35, #FFB74D);
            color: white;
        }

        .skill-icon-container.middle {
            background: linear-gradient(135deg, #FFD60A, #FF9500);
            color: white;
        }

        .skill-icon-container.senior {
            background: linear-gradient(135deg, #FF9500, #30D158);
            color: white;
        }

        .skill-icon-container.not-started {
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            color: white;
        }

        .skill-title {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        .skill-level {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .skill-level.junior {
            background: #e3f2fd;
            color: #1976d2;
        }

        .skill-level.middle {
            background: #fff3e0;
            color: #f57c00;
        }

        .skill-level.senior {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .skill-level.not-started {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .skill-progress-container {
            margin-top: 12px;
        }

        .skill-progress-label {
            font-size: 12px;
            color: #8e8e93;
            margin-bottom: 4px;
        }

        .skill-progress-bar {
            background: #f2f2f7;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .skill-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .skill-progress-fill.junior {
            background: linear-gradient(90deg, #FF6B35, #FFB74D);
        }

        .skill-progress-fill.middle {
            background: linear-gradient(90deg, #FFD60A, #FF9500);
        }

        .skill-progress-fill.senior {
            background: linear-gradient(90deg, #FF9500, #30D158);
        }

        .skill-progress-fill.completed {
            background: linear-gradient(90deg, #4CAF50, #66BB6A);
        }

        .skill-card.completed {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid #4CAF50;
            position: relative;
        }

        .skill-card.completed .skill-icon-container {
            background: linear-gradient(135deg, #4CAF50, #66BB6A) !important;
            color: white;
        }

        .skill-card.completed .skill-title {
            color: #2E7D32;
            font-weight: 600;
        }

        .skill-level.completed {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .skill-card.partial {
            background: rgba(255, 152, 0, 0.1);
            border: 2px solid #FF9800;
            position: relative;
        }

        .skill-card.partial .skill-icon-container {
            background: linear-gradient(135deg, #FF9800, #FFB74D) !important;
            color: white;
        }

        .skill-card.partial .skill-title {
            color: #E65100;
            font-weight: 600;
        }

        .skill-level.partial {
            background: #fff3e0;
            color: #e65100;
        }

        .skill-progress-fill.partial {
            background: linear-gradient(90deg, #FF9800, #FFB74D);
        }

        .completion-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
        }

        .partial-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #FF9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
        }

        .skill-progress-text {
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
            margin-top: 4px;
        }

        .function-link {
            color: inherit;
            text-decoration: none;
        }

        /* Auth Screen Styles */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            height: 100vh;
            padding: 20px;
            text-align: center;
            z-index: 2000;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.2);
            border: 1px solid rgba(255, 107, 53, 0.2);
            max-width: 350px;
            width: 100%;
            margin: auto;
        }

        .auth-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .auth-card h2 {
            color: #1d1d1f;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .auth-card p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .auth-btn {
            width: 100%;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
        }



        .telegram-btn {
            background: #ffffff;
            color: #0088cc;
            border: 1px solid #0088cc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            letter-spacing: 0.25px;
        }

        .telegram-btn:hover {
            background: #0088cc;
            color: white;
            box-shadow: 0 1px 2px 0 rgba(0,136,204,.30), 0 1px 3px 1px rgba(0,136,204,.15);
            transform: translateY(-1px);
        }

        .telegram-btn:hover svg path {
            fill: white;
        }

        /* Empty state styles */
        .empty-stats {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .empty-stats h3 {
            color: #1d1d1f;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .empty-stats p {
            color: #666;
            font-size: 16px;
            line-height: 1.5;
        }

        /* Category progress styles */
        .categories-progress {
            margin-top: 30px;
        }

        .categories-progress h3 {
            color: #1d1d1f;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .category-progress-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 107, 53, 0.1);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .category-name {
            font-weight: 600;
            color: #1d1d1f;
        }

        .category-score {
            font-weight: 600;
            color: #FF6B35;
        }

        .category-stats {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* Content placeholder styles */
        .content-placeholder {
            padding: 40px 20px;
            text-align: center;
        }

        .placeholder-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 40px 20px;
            margin: 0 auto;
            max-width: 500px;
        }

        .placeholder-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .placeholder-title {
            color: #1d1d1f;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .placeholder-description {
            color: #666;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 30px;
        }

        .placeholder-topics {
            margin: 30px 0;
        }

        .placeholder-topic {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 12px;
            padding: 12px 20px;
            margin: 10px 0;
        }

        .topic-icon {
            font-size: 20px;
            margin-right: 12px;
        }

        .topic-name {
            color: #1d1d1f;
            font-weight: 500;
        }

        .placeholder-note {
            color: #FF6B35;
            font-size: 14px;
            font-weight: 500;
            margin-top: 20px;
            line-height: 1.4;
        }

        /* Welcome New User Screen Styles - Updated Design */
        #welcome-new-user-screen {
            background: #F5EFE6;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .welcome-new-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 40px 20px 60px;
            text-align: center;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .welcome-header {
            margin-bottom: 40px;
        }

        .welcome-logo {
            margin-bottom: 24px;
            display: flex;
            justify-content: center;
        }

        .welcome-new-title {
            font-size: 24px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 16px;
            line-height: 1.3;
            text-align: center;
        }

        .welcome-new-description {
            font-size: 16px;
            color: #666666;
            line-height: 1.5;
            margin-bottom: 0;
            text-align: center;
        }

        .welcome-categories {
            margin-bottom: 40px;
        }

        .categories-title {
            font-size: 18px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 20px;
            text-align: center;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .welcome-category {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            border: 1px solid rgba(255, 167, 38, 0.2);
        }

        .category-icon {
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
        }

        .welcome-category .category-name {
            font-size: 14px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 4px;
        }

        .welcome-category .category-desc {
            font-size: 12px;
            color: #666666;
        }

        .show-more-topics {
            background: none;
            border: none;
            color: #1E88E5;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 auto;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .show-more-topics:hover {
            background: rgba(30, 136, 229, 0.1);
        }

        .start-screening-btn {
            background: linear-gradient(135deg, #FFA726, #FB8C00);
            color: white;
            font-size: 18px;
            font-weight: 600;
            padding: 18px 32px;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 32px;
            box-shadow: 0 4px 16px rgba(255, 167, 38, 0.3);
        }

        .start-screening-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 167, 38, 0.4);
        }

        .start-screening-btn:active {
            transform: translateY(0);
        }

        .welcome-benefits {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .benefit {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #333333;
            background: rgba(255, 255, 255, 0.6);
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .benefit span {
            flex: 1;
            text-align: left;
        }

        /* Mobile optimizations */
        /* Premium locked styles */
        .module-row.premium-locked {
            opacity: 0.6;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 183, 77, 0.1));
            border: 2px dashed rgba(255, 107, 53, 0.3);
            cursor: pointer;
        }

        .module-row.premium-locked:hover {
            opacity: 0.8;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.15), rgba(255, 183, 77, 0.15));
        }

        .premium-badge-small {
            background: linear-gradient(135deg, #FFD700, #FF8C00);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 2px;
        }

        /* Premium modal styles */
        .premium-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .premium-modal.hidden {
            display: none;
        }

        /* Search styles */
        .search-container {
            margin-top: 16px;
            margin-bottom: 16px;
        }

        .search-field {
            position: relative;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .search-field:focus-within {
            border-color: var(--tg-theme-button-color, #FF6B35);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--tg-theme-hint-color, #8e8e93);
            z-index: 2;
        }

        #module-search {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: none;
            background: transparent;
            font-size: 16px;
            color: var(--tg-theme-text-color, #000000);
            outline: none;
        }

        #module-search::placeholder {
            color: var(--tg-theme-hint-color, #8e8e93);
        }

        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--tg-theme-hint-color, #8e8e93);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }

        .search-clear:hover {
            background: var(--tg-theme-destructive-text-color, #ff3b30);
            transform: translateY(-50%) scale(1.1);
        }

        .search-clear svg {
            width: 12px;
            height: 12px;
        }

        .module-card.hidden, .module-row.hidden {
            display: none !important;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #8e8e93);
        }

        .no-results .no-results-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .no-results h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
        }

        .no-results p {
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }

        .premium-modal-content {
            background: linear-gradient(135deg, #F5E6D3, #E8C4A0);
            border-radius: 20px;
            padding: 32px 24px;
            max-width: 320px;
            margin: 16px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .premium-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .premium-title {
            font-size: 20px;
            font-weight: 700;
            color: #8B4513;
            margin-bottom: 8px;
        }

        .premium-subtitle {
            font-size: 14px;
            color: #A0522D;
            margin-bottom: 20px;
        }

        .premium-features {
            text-align: left;
            margin: 20px 0;
        }

        .premium-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #654321;
        }

        .premium-price {
            font-size: 24px;
            font-weight: 700;
            color: #8B4513;
            margin: 20px 0;
        }

        .btn-premium {
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            color: white;
            font-size: 16px;
            font-weight: 600;
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(255, 107, 53, 0.3);
        }

        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 107, 53, 0.4);
        }

        .btn-close-modal {
            background: transparent;
            color: #A0522D;
            font-size: 14px;
            padding: 8px 16px;
            border: 2px solid #D4A574;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
        }

        @media (max-width: 480px) {
            .welcome-new-container {
                padding: 32px 16px 50px;
            }

            .welcome-new-title {
                font-size: 20px;
            }

            .categories-grid {
                gap: 12px;
            }

            .welcome-category {
                padding: 12px 8px;
            }

            .start-screening-btn {
                font-size: 16px;
                padding: 16px 24px;
            }

            .benefit {
                font-size: 13px;
                padding: 10px 12px;
            }
        }

        /* Новый дизайн главного экрана */
        .nav-icon-new {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .nav-label-new {
            font-size: 18px;
            font-weight: bold;
            color: #333333;
        }

        .nav-item.active .nav-label-new {
            color: #FF6B35;
        }

        .welcome-card-new {
            background: #F8F9FA;
            border-radius: 16px;
            padding: 24px;
            margin: 20px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .welcome-header-new {
            text-align: center;
            margin-bottom: 24px;
        }

        .main-title {
            font-size: 24px;
            font-weight: bold;
            color: #333333;
            margin: 0 0 8px 0;
        }

        .main-subtitle {
            font-size: 14px;
            color: #666666;
            margin: 0;
        }

        .stats-overview-new {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .stats-overview-new .stat-item {
            text-align: center;
            background: white;
            border-radius: 12px;
            padding: 16px 8px;
        }

        .stats-overview-new .stat-number {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stats-overview-new .stat-text {
            font-size: 12px;
            color: #666666;
        }

        .progress-card-new {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .progress-header-new {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-label {
            font-size: 14px;
            color: #666666;
        }

        .progress-value {
            font-size: 14px;
            font-weight: bold;
            color: #FF6B35;
        }

        .progress-bar-container-new {
            background: #E9ECEF;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .progress-bar-fill-new {
            height: 100%;
            background: linear-gradient(90deg, #FF6B35, #28A745);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .xp-section-new {
            text-align: center;
        }

        .xp-text {
            font-size: 14px;
            color: #666666;
        }

        .xp-value {
            color: #FF6B35;
        }

        .action-buttons-new {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .action-btn-new {
            background: white;
            border: none;
            border-radius: 16px;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 150px;
            height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .daily-test-new {
            background: linear-gradient(135deg, #28A745, #20C997);
            color: white;
        }

        .practice-new {
            background: linear-gradient(135deg, #FFC107, #FF6B35);
            color: white;
        }

        .action-btn-new:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .btn-icon-new {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .btn-title-new {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .btn-subtitle-new {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Стили для страницы задач */
        .tasks-header {
            background: #FFFFFF;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tasks-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .tasks-icon {
            font-size: 24px;
            color: #28A745;
        }

        .tasks-title h1 {
            font-size: 24px;
            font-weight: bold;
            color: #28A745;
            margin: 0;
        }

        .tasks-subtitle {
            font-size: 14px;
            color: #6C757D;
            margin: 0;
        }

        .modules-grid-new {
            padding: 0 16px;
        }

        /* Modules table styles */
        .modules-table-container {
            padding: 16px;
        }

        @media (max-width: 480px) {
            .modules-table-container {
                padding: 8px;
            }
        }

        .modules-table {
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .modules-table-header {
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            color: white;
            padding: 16px;
            display: grid;
            grid-template-columns: 2fr 80px 60px;
            gap: 16px;
            font-weight: 600;
            font-size: 14px;
        }

        .modules-table-header > div {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .module-row {
            display: grid;
            grid-template-columns: 2fr 80px 60px;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
            align-items: center;
        }

        /* Mobile responsiveness for modules table */
        @media (max-width: 480px) {
            .modules-table-header {
                grid-template-columns: 2fr 60px 50px;
                gap: 8px;
                padding: 12px 8px;
                font-size: 12px;
            }

            .module-row {
                grid-template-columns: 2fr 60px 50px;
                gap: 8px;
                padding: 12px 8px;
            }

            .module-info {
                gap: 8px;
            }

            .module-icon-table {
                width: 32px;
                height: 32px;
                font-size: 20px;
            }

            .module-name {
                font-size: 14px;
            }

            .progress-bar-mini {
                width: 40px;
            }

            .progress-percentage {
                font-size: 14px;
            }

            .subcategories-count {
                font-size: 13px;
            }

            .module-progress {
                gap: 2px;
            }

            .premium-badge {
                font-size: 9px;
                padding: 2px 6px;
            }
        }

        .module-row:hover {
            background: rgba(255, 107, 53, 0.05);
        }

        .module-row:last-child {
            border-bottom: none;
        }

        .module-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .module-icon-table {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 10px;
        }

        .module-name {
            font-weight: 600;
            color: #1d1d1f;
            font-size: 16px;
        }

        .subcategories-count {
            color: #666;
            font-size: 14px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .module-progress {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-align: center;
        }

        .progress-percentage {
            font-weight: 600;
            color: #FF6B35;
            font-size: 16px;
        }

        .progress-bar-mini {
            width: 60px;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill-mini {
            height: 100%;
            background: linear-gradient(90deg, #FF6B35, #FF8C42);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-fill-mini.completed {
            background: linear-gradient(90deg, #30D158, #66BB6A) !important;
        }

        .progress-percentage.completed {
            color: #30D158 !important;
            font-weight: 600;
        }

        /* Social comparison modal styles */
        .social-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
            animation: modalFadeIn 0.3s ease-out;
        }

        .social-modal-content {
            background: linear-gradient(135deg, #ffffff, #f8f8f8);
            border-radius: 20px;
            padding: 30px;
            max-width: 340px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: modalSlideUp 0.3s ease-out;
        }

        .social-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .social-header h3 {
            margin: 0 0 15px 0;
            font-size: 22px;
            color: #333;
            font-weight: 600;
        }

        .user-result {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-score {
            font-size: 24px;
            font-weight: bold;
            color: #FF6B35;
        }

        .user-percentage {
            font-size: 18px;
            color: #666;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 8px;
        }

        .social-stats {
            margin-bottom: 25px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item.highlight {
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            margin: 10px -15px;
            padding: 15px;
            border-radius: 12px;
            color: white;
            border-bottom: none;
        }

        .stat-item.highlight .stat-label,
        .stat-item.highlight .stat-value {
            color: white;
            font-weight: 600;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .social-close-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .social-close-btn:hover {
            transform: translateY(-2px);
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes modalSlideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .module-card-new {
            background: #FFFFFF;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .module-card-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .module-header-new {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .module-icon-new {
            font-size: 32px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #F8F9FA;
            border-radius: 12px;
        }

        .module-info-new {
            flex: 1;
        }

        .module-title-new {
            font-size: 18px;
            font-weight: bold;
            color: #333333;
            margin: 0 0 4px 0;
        }

        .module-description-new {
            font-size: 14px;
            color: #6C757D;
            margin: 0;
        }

        .module-metrics-new {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        .metric-item-new {
            text-align: center;
            padding: 12px;
            background: #F8F9FA;
            border-radius: 8px;
        }

        .metric-value-new {
            font-size: 16px;
            font-weight: bold;
            color: #333333;
            margin-bottom: 4px;
        }

        .metric-label-new {
            font-size: 12px;
            color: #6C757D;
        }

        .metric-progress-new {
            color: #FFC107;
        }

        /* Стили для экрана тем модуля */
        .back-button-new {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #28A745;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 16px;
            padding: 8px 0;
        }

        .back-button-new:hover {
            color: #1e7e34;
        }

        .back-button-new svg {
            width: 20px;
            height: 20px;
        }

        #module-header-new {
            text-align: center;
            margin-bottom: 24px;
        }

        #module-header-new h2 {
            font-size: 24px;
            font-weight: bold;
            color: #333333;
            margin: 0 0 8px 0;
        }

        #module-header-new p {
            font-size: 14px;
            color: #6C757D;
            margin: 0;
        }

        .topics-grid-new {
            padding: 0 16px;
        }

        .topic-card-new {
            background: #FFFFFF;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .topic-card-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .topic-header-new {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .topic-icon-new {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #F8F9FA;
            border-radius: 8px;
        }

        .topic-title-new {
            font-size: 16px;
            font-weight: bold;
            color: #333333;
            margin: 0;
        }

        .topic-description-new {
            font-size: 14px;
            color: #6C757D;
            margin: 0 0 12px 0;
        }

        .topic-meta-new {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .topic-badge-new {
            background: #E9ECEF;
            color: #6C757D;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .topic-difficulty-new {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .topic-difficulty-new.beginner {
            background: #D4EDDA;
            color: #155724;
        }

        .topic-difficulty-new.intermediate {
            background: #FFF3CD;
            color: #856404;
        }

        .topic-difficulty-new.advanced {
            background: #F8D7DA;
            color: #721C24;
        }

        /* Profile Screen Styles */
        .profile-container {
            padding: 16px;
        }

        .profile-header-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 32px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 16px rgba(255, 107, 53, 0.3);
        }

        .profile-name {
            font-size: 24px;
            font-weight: 700;
            color: #2C2C2C;
            margin: 0 0 8px 0;
        }

        .profile-username {
            font-size: 16px;
            color: #FF6B35;
            margin: 0 0 16px 0;
            font-weight: 500;
        }

        .profile-badges {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .profile-badge {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: #5A4A3A;
            border: 1px solid rgba(255, 107, 53, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .profile-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .profile-stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .profile-stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #FF6B35;
            margin-bottom: 8px;
            display: block;
        }

        .profile-stat-label {
            font-size: 14px;
            color: #5A4A3A;
            font-weight: 500;
        }

        .profile-results-section {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .profile-section-title {
            font-size: 20px;
            font-weight: 700;
            color: #2C2C2C;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-category-result {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .profile-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .profile-category-name {
            font-size: 16px;
            font-weight: 600;
            color: #2C2C2C;
        }

        .profile-category-score {
            font-size: 18px;
            font-weight: 700;
            color: #FF6B35;
        }

        .profile-category-level {
            font-size: 14px;
            font-weight: 500;
            color: #5A4A3A;
            margin-bottom: 8px;
        }

        .profile-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .profile-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF6B35, #FF8C42);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .profile-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #5A4A3A;
        }

        .profile-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .profile-empty-text {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .profile-action-btn {
            background: #FF6B35;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-action-btn:hover {
            background: #FF8C42;
            transform: translateY(-2px);
        }

        .profile-achievements {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
        }

        .achievement-item {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .achievement-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .achievement-title {
            font-size: 12px;
            font-weight: 600;
            color: #2C2C2C;
            margin: 0;
        }

        .achievement-locked {
            opacity: 0.5;
        }

        /* Test History Styles */
        .test-history-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 107, 53, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-history-item:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
        }

        .test-history-header {
            margin-bottom: 12px;
        }

        .test-history-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .test-history-name {
            font-weight: 600;
            color: #2C2C2C;
            font-size: 16px;
        }

        .test-history-score {
            font-weight: bold;
            color: #FF6B35;
            font-size: 16px;
        }

        .test-history-level {
            font-size: 14px;
            color: #666;
        }

        .test-history-progress {
            height: 6px;
            background: rgba(255, 107, 53, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .test-history-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF6B35, #FF8C42);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .test-history-action {
            text-align: right;
        }

        .test-history-retry {
            font-size: 14px;
            color: #FF6B35;
            font-weight: 500;
        }

        /* Recommendations Styles */
        .recommendations-section {
            margin: 20px 16px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 107, 53, 0.2);
        }

        .recommendations-title {
            font-size: 18px;
            font-weight: 600;
            color: #2C2C2C;
            margin: 0 0 16px 0;
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recommendation-item {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 140, 66, 0.1));
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 107, 53, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recommendation-item:hover {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.2), rgba(255, 140, 66, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .recommendation-name {
            font-weight: 600;
            color: #2C2C2C;
            font-size: 16px;
        }

        .recommendation-badge {
            background: #FF6B35;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .recommendation-description {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        /* Modern Welcome Screen Styles */
        .modern-welcome-container {
            padding: 20px;
            max-width: 100%;
            margin: 0 auto;
        }

        .modern-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .ai-teacher-avatar {
            font-size: 64px;
            margin-bottom: 16px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }

        .greeting-section {
            margin-top: 16px;
        }

        .modern-greeting {
            font-size: 24px;
            font-weight: 700;
            color: #2C2C2C;
            margin: 0 0 12px 0;
            line-height: 1.3;
        }

        .modern-description {
            font-size: 16px;
            color: #666;
            line-height: 1.5;
            margin: 0;
        }

        .test-preview-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 24px;
            margin: 24px 0;
            border: 1px solid rgba(255, 107, 53, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .preview-title {
            font-size: 18px;
            font-weight: 600;
            color: #2C2C2C;
            margin: 0 0 20px 0;
            text-align: center;
        }

        .topic-cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .topic-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .topic-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.3));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .topic-card:hover::before {
            opacity: 1;
        }

        .topic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .math-topic {
            background: linear-gradient(135deg, #FFF9C4, #F57C00);
        }

        .python-topic {
            background: linear-gradient(135deg, #E8F5E8, #4CAF50);
        }

        .ml-topic {
            background: linear-gradient(135deg, #E3F2FD, #2196F3);
        }

        .topic-icon {
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            flex-shrink: 0;
        }

        .topic-info {
            flex: 1;
        }

        .topic-name {
            font-size: 16px;
            font-weight: 600;
            color: #2C2C2C;
            margin-bottom: 4px;
        }

        .topic-description {
            font-size: 14px;
            color: #666;
            line-height: 1.3;
        }

        .modern-cta-button {
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 18px 32px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            margin: 24px 0;
            position: relative;
            overflow: hidden;
        }

        .modern-cta-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .modern-cta-button:hover::before {
            left: 100%;
        }

        .modern-cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.6);
        }

        .modern-cta-button:active {
            transform: translateY(-1px);
        }

        .cta-text {
            font-size: 18px;
            font-weight: 700;
        }

        .cta-arrow {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .modern-cta-button:hover .cta-arrow {
            transform: translateX(4px);
        }

        .ai-feature-highlight {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05));
            border-radius: 16px;
            padding: 20px;
            margin: 24px 0;
            border: 1px solid rgba(33, 150, 243, 0.3);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .ai-chat-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .ai-feature-text {
            font-size: 15px;
            color: #2C2C2C;
            margin: 0;
            font-weight: 500;
        }

        .trust-section {
            margin-top: 32px;
        }

        .trust-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #2C2C2C;
        }

        .trust-check {
            font-size: 16px;
            flex-shrink: 0;
        }

        .trust-item span {
            font-weight: 500;
            line-height: 1.4;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .modern-greeting {
                font-size: 22px;
            }
            
            .modern-description {
                font-size: 15px;
            }
            
            .topic-card {
                padding: 14px;
                gap: 12px;
            }
            
            .topic-icon {
                font-size: 28px;
                width: 40px;
                height: 40px;
            }
        }

        /* Contact button styles */
        .contact-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, #0088cc, #00a0dc);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 136, 204, 0.3);
            width: 100%;
            max-width: 250px;
            margin: 0 auto;
        }

        .contact-button:hover {
            background: linear-gradient(135deg, #006aa3, #0080b3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 136, 204, 0.4);
            color: white;
            text-decoration: none;
        }

        .contact-button svg {
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-card">
            <div class="auth-icon">👤</div>
            <h2>Добро пожаловать!</h2>
            <p>Выберите способ входа, чтобы сохранить свой прогресс</p>
            
            <!-- Telegram validation status -->
            <div id="telegram-validation-status" style="display: none; margin-bottom: 20px; padding: 10px; border-radius: 8px; font-size: 14px;">
                <div id="validation-text"></div>
            </div>
            <button class="btn telegram-btn auth-btn" onclick="authenticateUser()">
                <svg width="18" height="18" viewBox="0 0 24 24" style="margin-right: 12px;">
                    <path fill="#0088cc" d="M12 0C5.376 0 0 5.376 0 12s5.376 12 12 12 12-5.376 12-12S18.624 0 12 0zm5.568 8.16c-.18 1.896-.96 6.504-1.356 8.628-.168.9-.504 1.2-.816 1.236-.696.06-1.224-.456-1.896-.9-1.056-.696-1.656-1.128-2.676-1.8-1.188-.78-.42-1.212.264-1.908.18-.18 3.252-2.976 3.312-3.228a.24.24 0 0 0-.06-.216c-.072-.06-.168-.036-.24-.024-.096.024-1.62 1.032-4.572 3.036-.432.3-.816.444-1.152.432-.38-.012-1.112-.216-1.656-.396-.668-.22-1.2-.336-1.152-.708.024-.192.252-.384.684-.576 2.688-1.176 4.476-1.956 5.364-2.34C17.568 9.048 18.588 8.16 18.568 8.16z"/>
                </svg>
                Continue with Telegram
            </button>

            <button class="btn btn-secondary auth-btn" onclick="continueAsGuest()">
                👤 Продолжить как гость
            </button>
        </div>
    </div>

    <div class="container">
        <div class="content">
            <!-- Modern Welcome Screen -->
            <div id="welcome-new-user-screen" class="hidden">
                <div class="modern-welcome-container">
                    <!-- Header Section -->
                    <div class="modern-header">
                        <div class="ai-teacher-avatar">🤖</div>
                        <div class="greeting-section">
                            <h1 class="modern-greeting">Привет! Давай подготовимся к собеседованию по ML.</h1>
                            <p class="modern-description">Пройди короткий тест и узнай свой уровень.<br>В приложении более 200 вопросов с реальных собеседований.</p>
                        </div>
                    </div>

                    <!-- Test Preview Section -->
                    <div class="test-preview-section">
                        <h2 class="preview-title">Тебя ждет тест из 10 вопросов по темам:</h2>
                        <div class="topic-cards-grid">
                            <div class="topic-card math-topic">
                                <div class="topic-icon">🟨</div>
                                <div class="topic-info">
                                    <div class="topic-name">Математика</div>
                                    <div class="topic-description">Базовые знания для ML</div>
                                </div>
                            </div>
                            <div class="topic-card python-topic">
                                <div class="topic-icon">🟩</div>
                                <div class="topic-info">
                                    <div class="topic-name">Python</div>
                                    <div class="topic-description">Основы программирования</div>
                                </div>
                            </div>
                            <div class="topic-card ml-topic">
                                <div class="topic-icon">🔵</div>
                                <div class="topic-info">
                                    <div class="topic-name">ML</div>
                                    <div class="topic-description">Алгоритмы и модели</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main CTA Button -->
                    <button class="modern-cta-button" onclick="startScreeningTest()">
                        <span class="cta-text">Начать тест</span>
                        <span class="cta-arrow">➡️</span>
                    </button>

                    <!-- AI Teacher Feature -->
                    <div class="ai-feature-highlight">
                        <div class="ai-chat-icon">💬</div>
                        <p class="ai-feature-text">Не знаешь ответ? Спроси ИИ-учителя прямо в приложении!</p>
                    </div>

                    <!-- Trust & Value Section -->
                    <div class="trust-section">
                        <div class="trust-item">
                            <div class="trust-check">✅</div>
                            <span>Тест займет 5 минут</span>
                        </div>
                        <div class="trust-item">
                            <div class="trust-check">✅</div>
                            <span>Вопросы от реальных компаний: Яндекс, Сбер, Тинькофф</span>
                        </div>
                        <div class="trust-item">
                            <div class="trust-check">✅</div>
                            <span>Объяснения от ИИ-учителя сразу после ответа</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Home Screen -->
            <div id="home-screen" class="hidden">
                <!-- Современная навигационная панель -->
                <div class="navigation-panel">
                    <div class="nav-item active" data-tab="categories">
                        <div class="nav-icon-new">🎯</div>
                        <div class="nav-label-new">Тесты</div>
                    </div>
                    <div class="nav-item" data-tab="progress">
                        <div class="nav-icon-new">📊</div>
                        <div class="nav-label-new">Прогресс</div>
                    </div>
                    <div class="nav-item" data-tab="profile">
                        <div class="nav-icon-new">👤</div>
                        <div class="nav-label-new">Профиль</div>
                    </div>
                </div>
                
                <!-- Debug info removed per user request -->

                <!-- Центральная карточка -->
                <div class="welcome-card-new">
                    <div class="welcome-header-new">
                        <h1 class="main-title">Interview Prep</h1>
                        <p class="main-subtitle">Подготовка к техническим собеседованиям с ИИ</p>
                    </div>

                    <div class="stats-overview-new" id="stats-overview">
                        <div class="stat-item">
                            <div class="stat-number" id="total-answered" style="color: #FF6B35;">0</div>
                            <div class="stat-text">Отвечено</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="overall-score" style="color: #666666;">0%</div>
                            <div class="stat-text">Общий балл</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="current-level" style="color: #FF6B35;">Junior</div>
                            <div class="stat-text">Уровень</div>
                        </div>
                    </div>

                    <div class="progress-card-new">
                        <div class="progress-header-new">
                            <span class="progress-label">Прогресс изучения</span>
                            <span id="progress-text" class="progress-value">0% to Junior Level</span>
                        </div>
                        <div class="progress-bar-container-new">
                            <div class="progress-bar-fill-new" id="level-progress-fill"></div>
                        </div>
                        <div class="xp-section-new">
                            <span class="xp-text">🎮 XP очки: <strong id="xp-count" class="xp-value">0</strong></span>
                        </div>
                    </div>

                    <div class="action-buttons-new">
                        <button class="action-btn-new daily-test-new" onclick="showLevelTest()">
                            <div class="btn-icon-new">✅</div>
                            <div class="btn-text-new">
                                <div class="btn-title-new">Daily Test</div>
                                <div class="btn-subtitle-new">+50 XP</div>
                            </div>
                        </button>
                        
                        <button class="action-btn-new practice-new" onclick="showRandomPractice()">
                            <div class="btn-icon-new">🎯</div>
                            <div class="btn-text-new">
                                <div class="btn-title-new">Practice</div>
                                <div class="btn-subtitle-new">Random Mix</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Рекомендации -->
                <div class="recommendations-section">
                    <h3 class="recommendations-title">💡 Рекомендации</h3>
                    <div id="recommendations-list" class="recommendations-list">
                        <!-- Recommendations will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Level Test Screen -->
            <div id="level-test-screen" class="screen hidden">
                <div class="header">
                    <h1>📊 Skills Assessment</h1>
                    <p>Выберите направление для тестирования</p>
                </div>

                <div class="skills-grid" id="categories-grid">
                    <!-- Categories will be loaded here -->
                </div>
            </div>

            <!-- Quiz Screen - Interactive Test -->
            <div id="quiz-screen" class="screen hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="quiz-progress"></div>
                </div>

                <div class="question-card">
                    <div class="question-header">
                        <span class="question-number" id="question-number">Вопрос 1</span>
                        <span class="question-progress" id="question-progress">1 из 5</span>
                    </div>

                    <div class="question-text" id="question-text">
                        <!-- Question will be loaded here -->
                    </div>

                    <ul class="options-list" id="options-list">
                        <!-- Options will be loaded here -->
                    </ul>

                    <div class="buttons-container">
                        <div class="buttons-row buttons-row-main">
                            <button class="btn btn-outline" id="prev-btn" onclick="previousQuestion()" style="display: none;">← Предыдущий</button>
                            <button class="btn btn-primary" id="submit-btn" disabled>Ответить</button>
                        </div>
                        <div class="buttons-row buttons-row-helper">
                            <button class="btn btn-secondary" id="hint-btn">💡 Подсказка</button>
                            <button class="btn btn-secondary" id="chat-btn">🤖 Чат с ИИ</button>
                        </div>
                        <div class="buttons-row buttons-row-exit">
                            <button class="btn btn-outline btn-exit" id="exit-quiz-btn" onclick="exitQuiz()">🚪 Выйти</button>
                        </div>
                    </div>

                    <div id="hint-container"></div>
                    <div id="chat-container" class="hidden">
                        <div class="chat-header">
                            <h4>💬 Чат с ИИ</h4>
                            <button id="close-chat" style="background: none; border: none; font-size: 18px; cursor: pointer;">✕</button>
                        </div>
                        <!-- Loading indicator -->
                        <div id="ai-loading" class="loading-indicator">
                            <div class="loading-dots">
                                <div class="dot"></div>
                                <div class="dot"></div>
                                <div class="dot"></div>
                            </div>
                            <span>ИИ обрабатывает запрос...</span>
                            <div class="timer-display" id="loading-timer">0.0с</div>
                        </div>
                        
                        <div id="chat-messages"></div>
                        <div class="quick-questions" id="quick-questions">
                            <button class="quick-question-btn" onclick="sendQuickQuestion('Объясни этот вопрос простыми словами')">
                                🔍 Объясни простыми словами
                            </button>
                            <button class="quick-question-btn" onclick="sendQuickQuestion('Покажи примеры использования этого в реальных проектах')">
                                💼 Примеры из практики
                            </button>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="chat-input" placeholder="Задайте вопрос ИИ...">
                            <button id="send-chat">Отправить</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Screen -->
            <div id="progress-screen" class="hidden">
                <div class="header">
                    <h1>📊 Мой прогресс</h1>
                </div>

                <div class="stats-card" id="progress-stats">
                    <!-- Progress stats will be loaded here -->
                </div>

                <div id="categories-progress">
                    <!-- Category progress will be loaded here -->
                </div>
            </div>

            <!-- Content Screen (Learning Materials) -->
            <div id="content-screen" class="hidden">
                <div class="header">
                    <h1>📚 Обучающие материалы</h1>
                    <p>Изучайте темы для успешного прохождения тестов</p>
                </div>

                <div class="content-placeholder">
                    <div class="placeholder-container">
                        <div class="placeholder-icon">
                            📖
                        </div>
                        <h3 class="placeholder-title">Скоро здесь появятся обучающие материалы</h3>
                        <p class="placeholder-description">
                            Мы работаем над созданием качественных обучающих материалов по всем темам:
                        </p>
                        <div class="placeholder-topics">
                            <div class="placeholder-topic">
                                <span class="topic-icon">🐍</span>
                                <span class="topic-name">Python разработка</span>
                            </div>
                            <div class="placeholder-topic">
                                <span class="topic-icon">🤖</span>
                                <span class="topic-name">Machine Learning</span>
                            </div>
                            <div class="placeholder-topic">
                                <span class="topic-icon">💬</span>
                                <span class="topic-name">NLP & Обработка языка</span>
                            </div>
                            <div class="placeholder-topic">
                                <span class="topic-icon">👁️</span>
                                <span class="topic-name">Computer Vision</span>
                            </div>
                        </div>
                        <p class="placeholder-note">
                            А пока вы можете проходить тесты и изучать объяснения от ИИ помощника!
                        </p>
                    </div>
                </div>
            </div>

            <!-- Profile Screen -->
            <div id="profile-screen" class="hidden">
                <div class="profile-container">
                    <!-- Profile Stats -->
                    <div class="profile-stats-grid">
                        <div class="profile-stat-card">
                            <span class="profile-stat-number" id="profile-total-score">0</span>
                            <span class="profile-stat-label">Общий балл</span>
                        </div>
                        <div class="profile-stat-card">
                            <span class="profile-stat-number" id="profile-total-questions">0</span>
                            <span class="profile-stat-label">Тестов пройдено</span>
                        </div>
                    </div>

                    <!-- Test History -->
                    <div class="profile-results-section">
                        <h3 class="profile-section-title">
                            📚 История тестов
                        </h3>
                        <div id="profile-test-history">
                            <!-- Test history will be loaded here -->
                        </div>
                    </div>

                    <!-- Achievements -->
                    <div class="profile-achievements">
                        <h3 class="profile-section-title">
                            🏆 Достижения
                        </h3>
                        <div class="achievement-grid">
                            <div class="achievement-item">
                                <span class="achievement-icon">🎯</span>
                                <p class="achievement-title">Первый тест</p>
                            </div>
                            <div class="achievement-item">
                                <span class="achievement-icon">⭐</span>
                                <p class="achievement-title">100 вопросов</p>
                            </div>
                            <div class="achievement-item achievement-locked">
                                <span class="achievement-icon">🔥</span>
                                <p class="achievement-title">Эксперт</p>
                            </div>
                            <div class="achievement-item achievement-locked">
                                <span class="achievement-icon">👑</span>
                                <p class="achievement-title">Чемпион</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Knowledge Base Screen -->
            <div id="knowledge-screen" class="hidden">
                <div class="header">
                    <h1>📚 База знаний по темам</h1>
                    <p>Материалы для изучения и подготовки</p>
                </div>

                <div class="knowledge-categories">
                    <div class="knowledge-category" onclick="openKnowledgeCategory('python')">
                        <div class="knowledge-icon">🐍</div>
                        <div class="knowledge-info">
                            <h3>Python разработка</h3>
                            <p>Основы языка, структуры данных, ООП</p>
                            <span class="knowledge-badge">15 статей</span>
                        </div>
                    </div>

                    <div class="knowledge-category" onclick="openKnowledgeCategory('ml')">
                        <div class="knowledge-icon">🤖</div>
                        <div class="knowledge-info">
                            <h3>Machine Learning</h3>
                            <p>Алгоритмы ML, нейронные сети, практика</p>
                            <span class="knowledge-badge">12 курсов</span>
                        </div>
                    </div>

                    <div class="knowledge-category" onclick="openKnowledgeCategory('nlp')">
                        <div class="knowledge-icon">💬</div>
                        <div class="knowledge-info">
                            <h3>NLP & AI</h3>
                            <p>Обработка естественного языка</p>
                            <span class="knowledge-badge">8 инструментов</span>
                        </div>
                    </div>

                    <div class="knowledge-category" onclick="openKnowledgeCategory('cv')">
                        <div class="knowledge-icon">👁️</div>
                        <div class="knowledge-info">
                            <h3>Computer Vision</h3>
                            <p>Распознавание изображений, OpenCV</p>
                            <span class="knowledge-badge">10 примеров</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Screen (was quiz-screen) -->
            <div id="tasks-screen" class="screen hidden">
                <div class="tasks-header">
                    <div class="tasks-title">
                        <span class="tasks-icon">✅</span>
                        <h1>Задачи по модулям</h1>
                    </div>
                    <p class="tasks-subtitle">Выберите модуль для изучения</p>
                    
                    <!-- Search Field -->
                    <div class="search-container">
                        <div class="search-field">
                            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                            </svg>
                            <input type="text" 
                                   id="module-search" 
                                   placeholder="Поиск по модулям..." 
                                   oninput="filterModules(this.value)">
                            <button class="search-clear" onclick="clearSearch()" id="clear-search" style="display: none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modules-table-container" id="modules-grid">
                    <div class="loading-placeholder">Загружаем модули...</div>
                </div>
            </div>

            <!-- Module Topics Screen -->
            <div id="module-topics-screen" class="screen hidden">
                <div class="tasks-header">
                    <div class="back-button-new" onclick="showScreen('tasks')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
                        </svg>
                        Назад к модулям
                    </div>
                    <div id="module-header-new">
                        <h2>Модуль</h2>
                        <p>Описание модуля</p>
                    </div>
                </div>
                
                <div class="topics-grid-new" id="topics-container">
                    <!-- Topics will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Нижняя навигация -->
    <div class="bottom-navigation">
        <div class="bottom-nav-grid">
            <div class="bottom-nav-item active" data-tab="home">
                <svg class="bottom-nav-icon" viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <div class="bottom-nav-label">Главная</div>
            </div>
            <div class="bottom-nav-item" data-tab="progress">
                <svg class="bottom-nav-icon" viewBox="0 0 24 24">
                    <path d="M3 5v14c0 1.1.89 2 2 2h14c0-1.1-.9-2-2-2H7V5H3zm11 5h4v2h-4v-2zm0 4h4v2h-4v-2zM8 10h4v2H8v-2zm0 4h4v2H8v-2z"/>
                </svg>
                <div class="bottom-nav-label">Аналитика</div>
            </div>
            <div class="bottom-nav-item" data-tab="quiz">
                <svg class="bottom-nav-icon" viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-8 11l-2-2 1.41-1.41L12 12.17l5.59-5.59L19 8l-7 7z"/>
                </svg>
                <div class="bottom-nav-label">Задачи</div>
            </div>
            <div class="bottom-nav-item" data-tab="content">
                <svg class="bottom-nav-icon" viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
                <div class="bottom-nav-label">Контент</div>
            </div>
            <div class="bottom-nav-item" data-tab="profile">
                <svg class="bottom-nav-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                </svg>
                <div class="bottom-nav-label">Профиль</div>
            </div>
        </div>
    </div>

    <script>
        // Telegram Web App initialization
        const tg = window.Telegram && window.Telegram.WebApp;
        if (tg) {
            tg.expand();
            tg.MainButton.hide();
        }

        // Application state
        let currentCategory = null;
        let currentSubcategory = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let selectedAnswer = null;
        let answered = false;
        let currentChatId = null;
        let loadingTimer = null;
        let loadingStartTime = null;
        
        // Quiz progress persistence
        let quizProgress = {
            category: null,
            questions: [],
            currentIndex: 0,
            answers: {},
            started: false
        };

        // Loading indicator functions - простое текстовое сообщение в чате
        function showLoadingMessage(message = 'Ожидание ответа...') {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                // Добавляем временное сообщение ожидания
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-message';
                loadingDiv.className = 'chat-message ai';
                loadingDiv.innerHTML = `<em style="opacity: 0.7;">${message}</em>`;
                
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                console.log('Showing loading message:', message);
            }
        }

        function hideLoadingMessage() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
                console.log('Hiding loading message');
            }
        }

        // Authentication functions
        async function authenticateUser() {
            try {
                // Check if running inside Telegram
                const isInTelegram = window.Telegram && window.Telegram.WebApp;
                console.log('Running inside Telegram:', isInTelegram);
                
                if (!isInTelegram) {
                    alert('Для авторизации через Telegram откройте приложение в Telegram Mini App');
                    return;
                }

                // Wait for Telegram WebApp to be ready
                await new Promise(resolve => {
                    if (window.Telegram.WebApp.isExpanded) {
                        resolve();
                    } else {
                        window.Telegram.WebApp.ready();
                        setTimeout(resolve, 1000);
                    }
                });

                // Get Telegram user data
                let telegram_user = null;
                const tgApp = window.Telegram.WebApp;
                
                // Try multiple ways to get user data
                if (tgApp.initDataUnsafe && tgApp.initDataUnsafe.user) {
                    telegram_user = tgApp.initDataUnsafe.user;
                    console.log('Telegram user detected from initDataUnsafe:', telegram_user);
                } else if (tgApp.initData) {
                    // Try to parse initData manually
                    try {
                        const urlParams = new URLSearchParams(tgApp.initData);
                        const userParam = urlParams.get('user');
                        if (userParam) {
                            telegram_user = JSON.parse(decodeURIComponent(userParam));
                            console.log('Telegram user parsed from initData:', telegram_user);
                        }
                    } catch (e) {
                        console.log('Failed to parse user from initData:', e);
                    }
                }

                if (telegram_user) {
                    await initializeApp(telegram_user, 'telegram');
                } else {
                    // In Telegram but no user data - create demo user for testing
                    console.log('In Telegram but no user data, creating demo Telegram user');
                    const demoTelegramUser = {
                        id: Date.now(), // Use timestamp for unique ID
                        first_name: "Telegram",
                        last_name: "Пользователь", 
                        username: "telegram_user_" + Date.now(),
                        language_code: "ru"
                    };
                    await initializeApp(demoTelegramUser, 'telegram');
                }
                
            } catch (error) {
                console.error('Authentication failed:', error);
                // Fallback to guest mode instead of showing error
                const proceed = confirm('Ошибка авторизации через Telegram. Продолжить как гость?');
                if (proceed) {
                    await continueAsGuest();
                }
            }
        }

        async function continueAsGuest() {
            await initializeApp(null, 'guest');
        }



        async function initializeApp(user_data, auth_type = 'guest') {
            // Track app initialization
            trackEvent('app_init', {
                auth_type: auth_type,
                has_user_data: !!user_data
            });
            
            try {
                const requestBody = {
                    auth_type: auth_type,
                    user_data: user_data
                };
                
                // Backward compatibility for Telegram
                if (auth_type === 'telegram') {
                    requestBody.telegram_user = user_data;
                    
                    // Add Telegram WebApp validation data
                    if (window.Telegram && window.Telegram.WebApp) {
                        const validationData = prepareTelegramValidationData();
                        if (validationData) {
                            requestBody.validation_data = validationData;
                            console.log('Adding validation data for Telegram auth');
                        } else {
                            requestBody.init_data = window.Telegram.WebApp.initData || '';
                            console.log('Adding basic initData for validation');
                        }
                    }
                }
                
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/init`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Hide auth screen
                    document.getElementById('auth-screen').style.display = 'none';
                    document.querySelector('.container').style.display = 'block';
                    
                    // Check if user is new (no previous test results)
                    const progressApiUrl = `${window.location.protocol}//${window.location.host}/api/progress`;
                    const progressResponse = await fetch(progressApiUrl);
                    const progressData = await progressResponse.json();
                    
                    if (progressResponse.ok && progressData.total_answered === 0) {
                        // New user - show welcome screen with screening test
                        showScreen('welcome-new-user');
                    } else {
                        // Existing user - show home screen
                        showScreen('home');
                        // Show bottom navigation after authentication
                        showBottomNavigation();
                        
                        if (data.profile && data.profile.telegram_first_name) {
                            showUserProfile(data.profile);
                        }
                        
                        await loadCategories();
                        await loadProgress();
                    }
                } else {
                    throw new Error('Failed to initialize');
                }
            } catch (error) {
                console.error('Failed to initialize app:', error);
                alert('Ошибка инициализации приложения');
            }
        }
        
        function showUserProfile(profile) {
            const header = document.querySelector('#home-screen .main-title');
            if (header && (profile.telegram_first_name || profile.telegram_username)) {
                // Приоритет: telegram_username > first_name + last_name
                let userName;
                if (profile.telegram_username) {
                    userName = '@' + profile.telegram_username;
                } else {
                    userName = profile.telegram_first_name + (profile.telegram_last_name ? ' ' + profile.telegram_last_name : '');
                }
                
                const authType = profile.telegram_id ? '📱' : (profile.email ? '🌐' : '👤');
                header.innerHTML = `${authType} Привет, ${userName}! 👋`;
                
                // Update subtitle as well
                const subtitle = document.querySelector('#home-screen .main-subtitle');
                if (subtitle) {
                    subtitle.textContent = 'Подготовка к техническим собеседованиям с ИИ';
                }
            }
        }
        
        function showDebugInfo(user_data, auth_type, profile) {
            const debugDiv = document.getElementById('debug-info');
            const tgIdDiv = document.getElementById('debug-tg-id');
            const usernameDiv = document.getElementById('debug-username');
            const authTypeDiv = document.getElementById('debug-auth-type');
            
            if (debugDiv && tgIdDiv && usernameDiv && authTypeDiv) {
                let tgId = 'не определен';
                let username = 'не определен';
                
                if (auth_type === 'telegram' && user_data) {
                    tgId = user_data.id || (profile && profile.telegram_id) || 'не определен';
                    username = user_data.username || (profile && profile.telegram_username) || 
                             user_data.first_name || (profile && profile.telegram_first_name) || 'не определен';
                } else if (auth_type === 'google' && user_data) {
                    tgId = 'Google User';
                    username = user_data.name || user_data.email || 'не определен';
                } else if (profile) {
                    tgId = profile.telegram_id || 'гость';
                    username = profile.telegram_username || profile.telegram_first_name || 'гость';
                }
                
                tgIdDiv.textContent = `TG ID: ${tgId}`;
                usernameDiv.textContent = `Username: ${username}`;
                authTypeDiv.textContent = `Auth: ${auth_type}`;
                
                debugDiv.style.display = 'block';
            }
        }

        // Initialize the app (legacy function)
        async function initApp() {
            // Check if user is already authenticated
            const telegram_user = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
            
            if (telegram_user) {
                // Auto-authenticate if Telegram data available
                await initializeApp(telegram_user);
            } else {
                // Show auth screen
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('home-screen').classList.add('hidden');
            }
        }

        async function loadCategories() {
            try {
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/categories`;
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.categories) {
                    displayCategories(data.categories);
                    updateOverallStats(data.overall_progress);
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        function displayCategories(categories) {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = '';

            const categoryIcons = {
                'Python': '🐍',
                'Machine Learning': '🤖',
                'NLP': '💬',
                'Computer Vision': '👁️'
            };

            const categoryNames = {
                'Python': 'Python',
                'Machine Learning': 'Machine Learning',
                'NLP': 'NLP',
                'Computer Vision': 'Computer Vision'
            };

            categories.forEach(category => {
                const card = document.createElement('div');
                card.className = 'skill-card';
                card.onclick = () => startQuiz(category.name);

                const level = getSkillLevel(category.score);
                const levelClass = level.toLowerCase().replace(' ', '-');

                card.innerHTML = `
                    <div class="skill-icon-container ${levelClass}">
                        ${categoryIcons[category.name] || '📚'}
                    </div>
                    <div class="skill-title">${categoryNames[category.name] || category.name}</div>
                    <div class="skill-level ${levelClass}">${level}</div>
                    <div class="skill-progress-container">
                        <div class="skill-progress-label">Progress</div>
                        <div class="skill-progress-bar">
                            <div class="skill-progress-fill ${levelClass}" style="width: ${category.score}%"></div>
                        </div>
                        <div class="skill-progress-text">${category.score.toFixed(0)}%</div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function getSkillLevel(score) {
            if (score === 0) return 'Not Started';
            if (score < 40) return 'Beginner';
            if (score < 70) return 'Junior';
            if (score < 85) return 'Middle';
            return 'Senior';
        }

        function updateOverallStats(progress) {
            // Update header level
            let level = getSkillLevel(progress.overall_score);
            document.getElementById('header-level').textContent = `${level} Level`;
            
            // Update progress card
            const progressPercent = Math.min(100, progress.overall_score);
            const fillElement = document.getElementById('level-progress-fill');
            if (fillElement) {
                fillElement.style.width = `${progressPercent}%`;
            }
            
            // Update progress text
            let nextLevel = 'Master';
            if (progress.overall_score < 40) nextLevel = 'Junior';
            else if (progress.overall_score < 70) nextLevel = 'Middle';
            else if (progress.overall_score < 85) nextLevel = 'Senior';
            
            const progressText = document.getElementById('progress-text');
            if (progressText && nextLevel !== 'Master') {
                const nextThreshold = nextLevel === 'Junior' ? 40 : nextLevel === 'Middle' ? 70 : 85;
                const percentToNext = Math.max(0, nextThreshold - progress.overall_score);
                progressText.textContent = `${(100 - percentToNext).toFixed(0)}% to ${nextLevel} Level`;
            } else if (progressText) {
                progressText.textContent = 'Master Level Achieved!';
            }
            
            // Update XP points (could be calculated from total correct answers)
            const xpPoints = progress.total_answered * 10 + (progress.overall_score * 2);
            document.getElementById('xp-count').textContent = Math.round(xpPoints).toLocaleString();
        }

        function showRandomPractice() {
            // For now, just redirect to level test
            showLevelTest();
        }

        async function startQuiz(category) {
            // Track quiz start
            trackTestEvent('start', category);
            trackPageView(`Тест: ${getCategoryDisplayName(category)}`);
            
            try {
                // Check if there's saved progress for this category
                const savedProgress = getSavedQuizProgress(category);
                
                if (savedProgress && savedProgress.questions.length > 0) {
                    const continueQuiz = confirm(`У вас есть незавершенный тест по "${getCategoryDisplayName(category)}". Продолжить с ${savedProgress.currentIndex + 1} вопроса?`);
                    
                    if (continueQuiz) {
                        trackEvent('test_resume', { category: category });
                        // Restore saved progress
                        currentCategory = savedProgress.category;
                        currentSubcategory = savedProgress.subcategory || null;
                        currentQuestions = savedProgress.questions;
                        currentQuestionIndex = savedProgress.currentIndex;
                        window.userAnswers = savedProgress.answers;
                        quizProgress = savedProgress;
                        answered = false;
                        showScreen('quiz');
                        displayQuestion();
                        return;
                    } else {
                        // Clear saved progress and start fresh
                        clearSavedQuizProgress(category);
                    }
                }
                
                // Start new quiz
                currentCategory = category;
                currentSubcategory = null; // Legacy quiz mode - no subcategory
                const response = await fetch(`/api/questions/${category}`);
                const data = await response.json();

                if (data.questions) {
                    currentQuestions = data.questions;
                    currentQuestionIndex = 0;
                    answered = false;
                    window.userAnswers = {}; // Track user answers for navigation
                    
                    // Initialize quiz progress
                    quizProgress = {
                        category: category,
                        questions: data.questions,
                        currentIndex: 0,
                        answers: {},
                        started: true
                    };
                    
                    showScreen('quiz');
                    displayQuestion();
                    saveQuizProgress(); // Save initial state
                } else {
                    console.error('No questions received for category:', category);
                    alert('Не удалось загрузить вопросы для категории: ' + category);
                }
            } catch (error) {
                console.error('Failed to load questions:', error);
            }
        }
        
        // Save quiz progress to localStorage
        function saveQuizProgress() {
            if (quizProgress.started) {
                quizProgress.currentIndex = currentQuestionIndex;
                quizProgress.answers = window.userAnswers || {};
                localStorage.setItem(`quiz_progress_${quizProgress.category}`, JSON.stringify(quizProgress));
                console.log('Quiz progress saved:', quizProgress);
            }
        }
        
        // Get saved quiz progress from localStorage
        function getSavedQuizProgress(category) {
            const saved = localStorage.getItem(`quiz_progress_${category}`);
            return saved ? JSON.parse(saved) : null;
        }
        
        // Clear saved quiz progress
        function clearSavedQuizProgress(category) {
            localStorage.removeItem(`quiz_progress_${category}`);
            console.log('Quiz progress cleared for category:', category);
        }
        
        // Exit quiz with confirmation
        function exitQuiz() {
            const totalQuestions = currentQuestions.length;
            const answeredQuestions = Object.keys(window.userAnswers || {}).length;
            
            if (answeredQuestions > 0 && currentQuestionIndex < totalQuestions) {
                const confirmExit = confirm(`Вы ответили на ${answeredQuestions} из ${totalQuestions} вопросов. Сохранить прогресс и выйти?`);
                
                if (confirmExit) {
                    saveQuizProgress();
                    // Return to categories screen
                    const quizTabButton = document.querySelector('.bottom-nav-item[data-tab="quiz"]');
                    if (quizTabButton) {
                        switchBottomTab('quiz', quizTabButton);
                    }
                }
            } else {
                // No progress to save, just exit
                clearSavedQuizProgress(currentCategory);
                const quizTabButton = document.querySelector('.bottom-nav-item[data-tab="quiz"]');
                if (quizTabButton) {
                    switchBottomTab('quiz', quizTabButton);
                }
            }
        }

        function displayQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            
            document.getElementById('question-number').textContent = `Вопрос ${currentQuestionIndex + 1}`;
            document.getElementById('question-progress').textContent = `${currentQuestionIndex + 1} из ${currentQuestions.length}`;
            
            // Display question text
            const questionTextEl = document.getElementById('question-text');
            questionTextEl.innerHTML = formatQuestionText(question.question);
            
            // Display image if present
            if (question.image_path) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'question-image-container';
                imageContainer.style.cssText = `
                    margin: 20px 0;
                    text-align: center;
                    padding: 16px;
                    background: rgba(255, 255, 255, 0.95);
                    border-radius: 12px;
                    border: 1px solid rgba(255, 107, 53, 0.2);
                `;
                
                const img = document.createElement('img');
                img.src = `/static/${question.image_path}`;
                img.alt = 'Изображение к вопросу';
                img.style.cssText = `
                    max-width: 100%;
                    max-height: 300px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    cursor: pointer;
                `;
                
                // Add click to zoom functionality
                img.onclick = () => {
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        cursor: pointer;
                    `;
                    
                    const zoomedImg = document.createElement('img');
                    zoomedImg.src = img.src;
                    zoomedImg.style.cssText = `
                        max-width: 90%;
                        max-height: 90%;
                        border-radius: 8px;
                    `;
                    
                    modal.appendChild(zoomedImg);
                    modal.onclick = () => modal.remove();
                    document.body.appendChild(modal);
                };
                
                imageContainer.appendChild(img);
                questionTextEl.appendChild(imageContainer);
            }

            const progressPercent = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('quiz-progress').style.width = `${progressPercent}%`;

            const optionsList = document.getElementById('options-list');
            optionsList.innerHTML = '';

            question.options.forEach((option, index) => {
                const li = document.createElement('li');
                li.className = 'option-item';
                li.textContent = option;
                li.onclick = () => selectOption(option, li);
                optionsList.appendChild(li);
            });

            // Update previous button visibility
            const prevBtn = document.getElementById('prev-btn');
            if (currentQuestionIndex > 0) {
                prevBtn.style.display = 'inline-block';
            } else {
                prevBtn.style.display = 'none';
            }

            // Check if this question was already answered
            const userAnswer = window.userAnswers ? window.userAnswers[currentQuestionIndex] : null;
            if (userAnswer) {
                // Show previous answer
                selectedAnswer = userAnswer.selected_answer;
                answered = true;
                
                // Mark the selected option
                const options = document.querySelectorAll('.option-item');
                options.forEach(option => {
                    if (option.textContent === userAnswer.selected_answer) {
                        option.classList.add('selected');
                        if (userAnswer.correct) {
                            option.classList.add('correct');
                        } else {
                            option.classList.add('incorrect');
                        }
                    }
                    // Не показываем правильный ответ при просмотре истории
                    // чтобы пользователь мог самостоятельно анализировать вопросы
                });
                
                // Update submit button
                const submitBtn = document.getElementById('submit-btn');
                if (currentQuestionIndex < currentQuestions.length - 1) {
                    submitBtn.textContent = 'Следующий вопрос';
                    submitBtn.onclick = nextQuestion;
                    submitBtn.disabled = false;
                } else {
                    submitBtn.textContent = 'Завершить тест';
                    submitBtn.onclick = finishQuiz;
                    submitBtn.disabled = false;
                }
            } else {
                // Reset for new question
                document.getElementById('submit-btn').disabled = true;
                document.getElementById('submit-btn').textContent = 'Ответить';
                document.getElementById('submit-btn').onclick = submitAnswer;
                selectedAnswer = null;
                answered = false;
            }

            document.getElementById('hint-container').innerHTML = '';
            document.getElementById('chat-container').classList.add('hidden');
            currentChatId = null;
        }

        function selectOption(option, element) {
            if (answered) return;

            // Remove selection from all options
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Select current option
            element.classList.add('selected');
            selectedAnswer = option;
            document.getElementById('submit-btn').disabled = false;
        }

        async function submitAnswer() {
            if (!selectedAnswer || answered) return;

            try {
                const question = currentQuestions[currentQuestionIndex];
                
                // Track answer submission
                trackEvent('question_answered', {
                    category: currentCategory,
                    question_index: currentQuestionIndex + 1,
                    total_questions: currentQuestions.length
                });
                
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/submit_answer`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        question_id: question.id,
                        answer: selectedAnswer,
                        category: currentCategory,
                        session_id: window.currentSessionId || getCookie('session_id') || 'guest_' + Date.now()
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    answered = true;
                    
                    // Track correct/incorrect answer
                    trackEvent(data.correct ? 'answer_correct' : 'answer_incorrect', {
                        category: currentCategory,
                        question_index: currentQuestionIndex + 1
                    });
                    
                    // Store user answer for navigation
                    window.userAnswers[currentQuestionIndex] = {
                        selected_answer: selectedAnswer,
                        correct_answer: data.correct_answer,
                        correct: data.correct
                    };
                    
                    showAnswerResult(data);
                    
                    // Save progress after answer submission
                    saveQuizProgress();
                    
                    // Update progress after answer submission
                    loadProgress();
                    
                    // Update button for next question
                    const submitBtn = document.getElementById('submit-btn');
                    if (currentQuestionIndex < currentQuestions.length - 1) {
                        submitBtn.textContent = 'Следующий вопрос';
                        submitBtn.onclick = nextQuestion;
                    } else {
                        submitBtn.textContent = 'Завершить тест';
                        submitBtn.onclick = finishQuiz;
                    }
                }
            } catch (error) {
                console.error('Failed to submit answer:', error);
            }
        }

        function showAnswerResult(data) {
            document.querySelectorAll('.option-item').forEach(item => {
                if (item.textContent === selectedAnswer) {
                    if (data.correct) {
                        item.classList.add('correct'); // Green for correct answer
                    } else {
                        item.classList.add('incorrect'); // Red for incorrect answer
                    }
                }
                // Не подсвечиваем правильный ответ при неправильном выборе
                // чтобы пользователь сам разбирался в материале
            });
        }

        async function getHint() {
            // Track hint request
            trackEvent('hint_requested', {
                category: currentCategory,
                question_index: currentQuestionIndex + 1
            });
            
            try {
                const question = currentQuestions[currentQuestionIndex];
                
                // Show loading message
                showLoadingMessage('Получаем подсказку...');
                
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/hint`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question_id: question.id
                    })
                });

                const data = await response.json();
                hideLoadingMessage(); // Hide loading message

                if (response.ok && data.hint) {
                    const container = document.getElementById('hint-container');
                    container.innerHTML = `
                        <div class="hint-card">
                            <h4>💡 Подсказка:</h4>
                            <p>${data.hint}</p>
                        </div>
                    `;
                }
            } catch (error) {
                hideLoadingMessage(); // Hide loading message on error
                console.error('Failed to get hint:', error);
            }
        }

        async function startAIChat() {
            // Track AI chat start
            trackEvent('ai_chat_start', {
                category: currentCategory,
                question_index: currentQuestionIndex + 1
            });
            
            try {
                const question = currentQuestions[currentQuestionIndex];
                
                // Show loading message
                showLoadingMessage('Запускаем ИИ помощника...');
                
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/chat/start`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',  // Include cookies for session
                    body: JSON.stringify({
                        question_id: question.id
                    })
                });

                const data = await response.json();
                hideLoadingMessage(); // Hide loading message

                if (response.ok) {
                    currentChatId = data.chat_id;
                    const chatContainer = document.getElementById('chat-container');
                    const chatMessages = document.getElementById('chat-messages');
                    
                    chatMessages.innerHTML = `
                        <div class="chat-message ai">
                            ${formatAIMessage(data.message)}
                        </div>
                    `;
                    
                    chatContainer.classList.remove('hidden');
                    chatContainer.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                hideLoadingMessage(); // Hide loading message on error
                console.error('Failed to start AI chat:', error);
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !currentChatId) return;
            
            // Track chat message send
            trackEvent('ai_chat_message', {
                category: currentCategory,
                question_index: currentQuestionIndex + 1,
                message_length: message.length
            });
            
            try {
                // Add user message to chat
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML += `
                    <div class="chat-message user">
                        ${message}
                    </div>
                `;
                
                input.value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Show loading message
                showLoadingMessage('ИИ генерирует ответ...');
                
                // Send to AI
                console.log('Sending message to AI:', message, 'Chat ID:', currentChatId);
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/chat/message`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',  // Include cookies for session
                    body: JSON.stringify({
                        chat_id: currentChatId,
                        message: message
                    })
                });

                const data = await response.json();
                console.log('AI response received:', data);
                hideLoadingMessage(); // Hide loading message

                if (response.ok) {
                    chatMessages.innerHTML += `
                        <div class="chat-message ai">
                            ${formatAIMessage(data.message)}
                        </div>
                    `;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    console.error('AI response error:', response.status, data);
                    chatMessages.innerHTML += `
                        <div class="chat-message ai">
                            <strong>Ошибка:</strong> ${data.error || 'Не удалось получить ответ от ИИ'}
                        </div>
                    `;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } catch (error) {
                hideLoadingMessage(); // Hide loading message on error
                console.error('Failed to send chat message:', error);
                
                // Show error in chat
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML += `
                    <div class="chat-message ai">
                        <strong>Ошибка:</strong> Не удалось отправить сообщение. Попробуйте еще раз.
                    </div>
                `;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function closeChatContainer() {
            document.getElementById('chat-container').classList.add('hidden');
            currentChatId = null;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            saveQuizProgress(); // Save progress after moving to next question
            displayQuestion();
            
            // Reset submit button
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.textContent = 'Ответить';
            submitBtn.onclick = submitAnswer;
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                saveQuizProgress(); // Save progress after moving to previous question
                displayQuestion();
            }
        }

        async function finishQuiz() {
            // Calculate test results
            const totalQuestions = currentQuestions.length;
            const answeredQuestions = Object.keys(window.userAnswers || {});
            const correctAnswers = answeredQuestions.filter(questionId => 
                window.userAnswers[questionId]?.correct
            ).length;
            
            // Track quiz completion
            trackTestEvent('complete', currentCategory, {
                questions_total: totalQuestions,
                questions_answered: answeredQuestions.length,
                score: correctAnswers
            });
            trackPageView('Результаты теста');
            
            // Clear saved progress when quiz is completed
            clearSavedQuizProgress(currentCategory);
            
            // Try to get social comparison statistics
            console.log('finishQuiz called with:', {
                category: currentCategory,
                subcategory: currentSubcategory || 'Тест',
                correctAnswers,
                totalQuestions
            });
            
            try {
                const requestData = {
                    category: currentCategory,
                    subcategory: currentSubcategory || 'Тест',
                    score: correctAnswers,
                    total_questions: totalQuestions
                };
                
                console.log('Sending request to /api/test/complete:', requestData);
                
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/test/complete`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const socialData = await response.json();
                    console.log('Social comparison data received:', socialData);
                    
                    // Show social comparison if we have data
                    if (socialData.social_stats && socialData.social_stats.total_users > 0) {
                        console.log('Showing social comparison modal');
                        showSocialComparison(socialData.social_stats, correctAnswers, totalQuestions);
                        return; // Don't show progress immediately, let modal handle it
                    } else {
                        console.log('No social stats to show');
                    }
                } else {
                    console.error('Response not ok:', response.status);
                }
            } catch (error) {
                console.error('Failed to get social stats:', error);
            }
            
            // If no social comparison, go directly to progress
            showScreen('progress');
            loadProgress();
        }
        
        function showSocialComparison(socialStats, userScore, totalQuestions) {
            console.log('showSocialComparison called with:', {socialStats, userScore, totalQuestions});
            
            // Create modal for social comparison
            const modal = document.createElement('div');
            modal.className = 'social-modal';
            modal.innerHTML = `
                <div class="social-modal-content">
                    <div class="social-header">
                        <h3>🎉 Тест завершён!</h3>
                        <div class="user-result">
                            <span class="user-score">${userScore}/${totalQuestions}</span>
                            <span class="user-percentage">${Math.round((userScore/totalQuestions)*100)}%</span>
                        </div>
                    </div>
                    
                    <div class="social-stats">
                        <div class="stat-item">
                            <span class="stat-label">Средний результат:</span>
                            <span class="stat-value">${socialStats.average_score}/${totalQuestions}</span>
                        </div>
                        
                        <div class="stat-item highlight">
                            <span class="stat-label">Вы справились лучше чем:</span>
                            <span class="stat-value">${socialStats.better_than_percentage}% людей</span>
                        </div>
                        
                        <div class="stat-item">
                            <span class="stat-label">Всего прошли тест:</span>
                            <span class="stat-value">${socialStats.total_users} человек</span>
                        </div>
                    </div>
                    
                    <button class="social-close-btn" onclick="closeSocialModal()">Продолжить</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto close after 8 seconds
            setTimeout(() => {
                closeSocialModal();
            }, 8000);
        }
        
        function closeSocialModal() {
            const modal = document.querySelector('.social-modal');
            if (modal) {
                modal.remove();
                
                // Now show progress screen after modal is closed
                showScreen('progress');
                loadProgress();
            }
        }

        async function loadProgress() {
            try {
                console.log('Loading progress data...');
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/progress`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                console.log('Progress API response:', data);

                if (response.ok) {
                    displayProgress(data);
                    // Also update profile with the same data
                    displayProfile({ auth_type: 'telegram' }, data);
                    // Update home page stats too
                    updateHomeStats(data);
                } else {
                    console.error('Failed to load progress:', data.error);
                    if (data.error && data.error.includes('авторизован')) {
                        console.log('User not authorized, showing empty progress');
                        displayProgress({
                            overall_score: 0,
                            total_answered: 0,
                            categories: [],
                            overall_level: 'Junior'
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load progress:', error);
            }
        }

        function displayProgress(data) {
            const statsContainer = document.getElementById('progress-stats');
            
            // Handle empty data
            if (!data || !data.categories || data.categories.length === 0) {
                statsContainer.innerHTML = `
                    <div class="empty-stats">
                        <div class="empty-icon">📊</div>
                        <h3>Пока нет данных</h3>
                        <p>Пройдите первый тест, чтобы увидеть статистику</p>
                    </div>
                `;
                return;
            }
            
            // Calculate overall stats if missing
            let overallScore = data.overall_score || 0;
            let overallLevel = data.overall_level || 'Junior';
            let totalAnswered = data.total_answered || 0;
            let totalCorrect = data.total_correct || 0;
            
            statsContainer.innerHTML = `
                <div class="stats-overview">
                    <div class="stats-row">
                        <span class="stat-label">Общий балл</span>
                        <span class="stat-value">${Math.round(overallScore)}%</span>
                    </div>
                    <div class="stats-row">
                        <span class="stat-label">Уровень</span>
                        <span class="stat-value">${overallLevel}</span>
                    </div>
                    <div class="stats-row">
                        <span class="stat-label">Отвечено вопросов</span>
                        <span class="stat-value">${totalAnswered}</span>
                    </div>
                    <div class="stats-row">
                        <span class="stat-label">Правильных ответов</span>
                        <span class="stat-value">${totalCorrect}</span>
                    </div>
                </div>
                
                <div class="categories-progress">
                    <h3>Прогресс по категориям</h3>
                    ${Array.isArray(data.categories) ? 
                        data.categories.map(cat => `
                            <div class="category-progress-item">
                                <div class="category-header">
                                    <span class="category-name">${cat.category}</span>
                                    <span class="category-score">${Math.round(cat.score)}%</span>
                                </div>
                                <div class="skill-progress-bar">
                                    <div class="skill-progress-fill ${cat.level.toLowerCase()}" 
                                         style="width: ${cat.score}%"></div>
                                </div>
                                <div class="category-stats">
                                    ${cat.correct}/${cat.total} • ${cat.level}
                                </div>
                            </div>
                        `).join('') : 
                        Object.keys(data.categories || {}).map(catKey => {
                            const cat = data.categories[catKey];
                            return `
                                <div class="category-progress-item">
                                    <div class="category-header">
                                        <span class="category-name">${catKey}</span>
                                        <span class="category-score">${Math.round(cat.score || 0)}%</span>
                                    </div>
                                    <div class="skill-progress-bar">
                                        <div class="skill-progress-fill ${(cat.level || 'junior').toLowerCase()}" 
                                             style="width: ${cat.score || 0}%"></div>
                                    </div>
                                    <div class="category-stats">
                                        ${cat.correct || 0}/${cat.total || 0} • ${cat.level || 'Junior'}
                                    </div>
                                </div>
                            `;
                        }).join('')
                    }
                </div>
            `;
        }

        function showScreen(screenName) {
            // Hide all screens
            document.querySelectorAll('#home-screen, #level-test-screen, #quiz-screen, #progress-screen').forEach(screen => {
                screen.classList.add('hidden');
            });

            // Show selected screen
            document.getElementById(`${screenName}-screen`).classList.remove('hidden');

            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (screenName === 'home') {
                document.querySelector('.nav-btn:first-child').classList.add('active');
            } else if (screenName === 'progress') {
                document.querySelector('.nav-btn:last-child').classList.add('active');
            }
        }

        async function showLevelTest() {
            // Daily test should start a random test from any available subcategory
            try {
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/modules`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                // API returns modules directly as array, not nested in data.modules
                const modules = Array.isArray(data) ? data : (data.modules || []);
                
                if (modules.length > 0) {
                    // Get all available subcategories from all modules
                    const availableSubcategories = [];
                    
                    modules.forEach(module => {
                        if (!module.is_premium && module.topics && module.topics.length > 0) {
                            module.topics.forEach(sub => {
                                availableSubcategories.push({
                                    category: module.id,
                                    subcategory: sub.name,
                                    categoryName: module.name
                                });
                            });
                        }
                    });
                    
                    if (availableSubcategories.length > 0) {
                        // Pick a random subcategory
                        const randomIndex = Math.floor(Math.random() * availableSubcategories.length);
                        const randomSub = availableSubcategories[randomIndex];
                        
                        console.log(`Daily test: Starting random test from ${randomSub.categoryName} - ${randomSub.subcategory}`);
                        
                        // Start the test directly
                        startSubcategoryQuiz(randomSub.category, randomSub.subcategory);
                    } else {
                        // Fallback to screening test if no subcategories available
                        console.log('Daily test: No subcategories available, starting screening test');
                        startSubcategoryQuiz('Screening Test', 'Тест');
                    }
                } else {
                    console.error('Daily test: No modules data available');
                    showError('Не удалось загрузить данные для Daily Test');
                }
            } catch (error) {
                console.error('Daily test error:', error);
                showError('Ошибка при запуске Daily Test');
            }
        }

        function sendQuickQuestion(question) {
            const chatInput = document.getElementById('chat-input');
            chatInput.value = question;
            sendChatMessage();
        }

        function formatQuestionText(text) {
            return text
                // Convert code blocks
                .replace(/```python\n([\s\S]*?)\n```/g, '<div class="code-block">$1</div>')
                .replace(/```([\s\S]*?)```/g, '<div class="code-block">$1</div>')
                // Convert inline code
                .replace(/`([^`]+)`/g, '<code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>')
                // Convert line breaks
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
        }

        // Format AI messages with better display
        function formatAIMessage(message) {
            return message
                // Replace code separators with styled dividers
                .replace(/\n---\n/g, '<div class="code-separator"></div>')
                // Convert code blocks (text between ``` or ---)
                .replace(/```([\s\S]*?)```/g, '<div class="code-block">$1</div>')
                .replace(/---([\s\S]*?)---/g, '<div class="code-block">$1</div>')
                // Convert markdown bold text **text** to <strong>
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Convert markdown italic text *text* to <em>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Convert inline code `code` to styled spans
                .replace(/`([^`]+)`/g, '<code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>')
                // Convert regular line breaks
                .replace(/\n/g, '<br>')
                // Convert bullets to better formatting
                .replace(/• /g, '💫 ')
                // Make emojis in headers bigger
                .replace(/(🤖|📝|📋|💡)/g, '<span style="font-size: 1.2em;">$1</span>');
        }

        // Event listeners
        document.getElementById('submit-btn').onclick = submitAnswer;
        document.getElementById('hint-btn').onclick = getHint;
        document.getElementById('chat-btn').onclick = startAIChat;
        document.getElementById('close-chat').onclick = closeChatContainer;
        document.getElementById('send-chat').onclick = sendChatMessage;
        
        // Enter key in chat input
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Always show auth screen initially
            document.getElementById('auth-screen').style.display = 'flex';
            
            // Check if we have Telegram user data and auto-authenticate
            setTimeout(() => {
                let hasTelegramData = false;
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                    hasTelegramData = true;
                } else if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    hasTelegramData = true;
                }
                
                if (hasTelegramData) {
                    // Auto-authenticate with Telegram data
                    authenticateUser();
                }
            }, 500); // Small delay to ensure Telegram WebApp is initialized
        });
        // Navigation functionality
        function initNavigation() {
            // Top navigation
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const tab = item.getAttribute('data-tab');
                    switchTab(tab, item);
                });
            });

            // Bottom navigation
            const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
            bottomNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    const tab = item.getAttribute('data-tab');
                    switchBottomTab(tab, item);
                });
            });
        }

        function switchBottomTab(tabName, clickedItem) {
            // Track navigation event
            trackEvent('navigation', {
                destination: tabName,
                from_screen: getCurrentScreen()
            });
            
            // Track page view for each tab
            const tabNames = {
                'home': 'Главная',
                'progress': 'Аналитика',
                'quiz': 'Тесты',
                'content': 'Контент',
                'profile': 'Профиль'
            };
            trackPageView(tabNames[tabName] || tabName);
            
            // Remove active class from all bottom nav items
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            clickedItem.classList.add('active');
            
            // Handle tab switching logic
            switch(tabName) {
                case 'home':
                    showScreen('home');
                    break;
                case 'progress':
                    showScreen('progress');
                    loadProgress();
                    break;
                case 'quiz':
                    showScreen('tasks');
                    loadQuizCategories();
                    break;
                case 'content':
                    showScreen('content');
                    break;
                case 'profile':
                    showScreen('profile');
                    loadProfile();
                    break;
            }
        }
        
        // Helper function to get current screen
        function getCurrentScreen() {
            const allScreens = [
                'home-screen', 'tasks-screen', 'quiz-screen', 'progress-screen', 
                'content-screen', 'profile-screen', 'knowledge-screen', 
                'level-test-screen', 'results-screen', 'module-topics-screen',
                'welcome-new-user-screen', 'auth-screen'
            ];
            
            return allScreens.find(screenId => {
                const element = document.getElementById(screenId);
                return element && !element.classList.contains('hidden');
            })?.replace('-screen', '') || 'unknown';
        }

        function showScreen(screenName) {
            // Hide ALL possible screens
            const allScreens = [
                'home-screen', 'tasks-screen', 'quiz-screen', 'progress-screen', 
                'content-screen', 'profile-screen', 'knowledge-screen', 
                'level-test-screen', 'results-screen', 'module-topics-screen',
                'welcome-new-user-screen'
            ];
            
            allScreens.forEach(screenId => {
                const element = document.getElementById(screenId);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            // Show target screen
            const targetElement = document.getElementById(`${screenName}-screen`);
            if (targetElement) {
                targetElement.classList.remove('hidden');
            }
            
            console.log('Switched to screen:', screenName);
        }

        function switchTab(tabName, clickedItem) {
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            clickedItem.classList.add('active');
            
            // Handle tab switching logic
            switch(tabName) {
                case 'categories':
                    showScreen('home');
                    break;
                case 'progress':
                    showScreen('progress');
                    loadProgress();
                    break;
                case 'content':
                    showScreen('content');
                    break;
                case 'profile':
                    showScreen('profile');
                    loadProfile();
                    break;
                case 'knowledge':
                    showScreen('knowledge');
                    loadKnowledgeBase();
                    break;
            }
        }

        // Load stats overview
        async function loadStatsOverview() {
            try {
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/progress`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('total-answered').textContent = data.total_answered || 0;
                    document.getElementById('overall-score').textContent = Math.round(data.overall_score || 0) + '%';
                    document.getElementById('current-level').textContent = data.overall_level || 'Junior';
                }
            } catch (error) {
                console.error('Failed to load stats overview:', error);
            }
        }

        // Load profile data
        async function loadProfile() {
            try {
                console.log('Loading profile data...');
                
                // Load user profile
                const profileApiUrl = `${window.location.protocol}//${window.location.host}/api/profile`;
                const profileResponse = await fetch(profileApiUrl);
                const profileData = await profileResponse.json();
                
                // Load user progress
                const progressApiUrl = `${window.location.protocol}//${window.location.host}/api/progress`;
                const progressResponse = await fetch(progressApiUrl);
                const progressData = await progressResponse.json();
                
                if (profileResponse.ok && progressResponse.ok) {
                    displayProfile(profileData, progressData);
                } else {
                    console.error('Failed to load profile:', profileData.error || progressData.error);
                    showProfileError();
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
                showProfileError();
            }
        }

        function displayProfile(profile, progress) {
            console.log('Displaying profile:', profile);
            console.log('Progress data:', progress);
            
            // Update stats
            const totalScoreElement = document.getElementById('profile-total-score');
            const totalQuestionsElement = document.getElementById('profile-total-questions');
            
            if (totalScoreElement) totalScoreElement.textContent = Math.round(progress.overall_score || 0) + '%';
            if (totalQuestionsElement) totalQuestionsElement.textContent = progress.total_answered || 0;
            
            // Update test history
            const historyContainer = document.getElementById('profile-test-history');
            if (historyContainer) {
                if (progress.categories && progress.categories.length > 0) {
                    historyContainer.innerHTML = progress.categories.map(category => `
                        <div class="test-history-item" onclick="startCategoryTest('${category.category}')">
                            <div class="test-history-header">
                                <div class="test-history-info">
                                    <span class="test-history-name">${getCategoryDisplayName(category.category)}</span>
                                    <span class="test-history-score">${Math.round(category.score)}%</span>
                                </div>
                                <div class="test-history-level">Уровень: ${category.level}</div>
                            </div>
                            <div class="test-history-progress">
                                <div class="test-history-progress-fill" style="width: ${category.score}%"></div>
                            </div>
                            <div class="test-history-action">
                                <span class="test-history-retry">Пройти заново →</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyContainer.innerHTML = `
                        <div class="profile-empty-state">
                            <div class="profile-empty-icon">📚</div>
                            <div class="profile-empty-text">Пройдите первый тест, чтобы увидеть историю</div>
                            <button class="profile-action-btn" onclick="showTab('categories'); loadCategories();">
                                Начать тест
                            </button>
                        </div>
                    `;
                }
            }
            
            // Load recommendations for home page
            loadRecommendations();
            
            // Update home page stats
            updateHomeStats(progress);
        }

        function getCategoryDisplayName(category) {
            const names = {
                'Screening Test': 'Скрининговый тест',
                'Python': 'Python',
                'Machine Learning': 'Машинное обучение',
                'NLP': 'Обработка языка',
                'Computer Vision': 'Компьютерное зрение'
            };
            return names[category] || category;
        }

        // Start category test from profile history
        function startCategoryTest(category) {
            console.log('Starting test for category:', category);
            
            // Find the quiz tab button and click it
            const quizTabButton = document.querySelector('.bottom-nav-item[data-tab="quiz"]');
            if (quizTabButton) {
                switchBottomTab('quiz', quizTabButton);
            }
            
            // Start the quiz directly with the category after a short delay
            setTimeout(() => {
                startQuiz(category);
            }, 200);
        }

        // Update home page stats
        function updateHomeStats(progress) {
            const totalAnsweredEl = document.getElementById('total-answered');
            const overallScoreEl = document.getElementById('overall-score');
            const currentLevelEl = document.getElementById('current-level');
            const xpCountEl = document.getElementById('xp-count');
            const progressTextEl = document.getElementById('progress-text');
            const progressFillEl = document.getElementById('level-progress-fill');
            
            if (totalAnsweredEl) totalAnsweredEl.textContent = progress.total_answered || 0;
            if (overallScoreEl) overallScoreEl.textContent = Math.round(progress.overall_score || 0) + '%';
            if (currentLevelEl) currentLevelEl.textContent = progress.overall_level || 'Junior';
            if (xpCountEl) xpCountEl.textContent = (progress.total_answered || 0) * 10; // 10 XP per question
            
            // Update progress bar
            const score = progress.overall_score || 0;
            const level = progress.overall_level || 'Junior';
            
            if (progressTextEl) {
                let nextLevel = level === 'Junior' ? 'Middle' : level === 'Middle' ? 'Senior' : 'Expert';
                progressTextEl.textContent = `${Math.round(score)}% to ${nextLevel} Level`;
            }
            
            if (progressFillEl) {
                let progressPercentage = 0;
                if (level === 'Junior') progressPercentage = score * 0.75; // 0-75% for Junior
                else if (level === 'Middle') progressPercentage = 75 + (score - 60) * 0.625; // 75-100% for Middle
                else progressPercentage = 100; // 100% for Senior
                
                progressFillEl.style.width = Math.min(progressPercentage, 100) + '%';
            }
        }

        // Load recommendations for home page
        function loadRecommendations() {
            const recommendationsContainer = document.getElementById('recommendations-list');
            if (!recommendationsContainer) return;
            
            // Get all available categories
            const allCategories = [
                { name: 'python', display: 'Python', description: 'Основы языка и продвинутые техники' },
                { name: 'machine_learning', display: 'Machine Learning', description: 'Алгоритмы и методы машинного обучения' },
                { name: 'nlp', display: 'NLP', description: 'Обработка естественного языка' },
                { name: 'computer_vision', display: 'Computer Vision', description: 'Компьютерное зрение и анализ изображений' }
            ];
            
            // Randomly select 2 categories for recommendations
            const shuffled = allCategories.sort(() => 0.5 - Math.random());
            const recommended = shuffled.slice(0, 2);
            
            recommendationsContainer.innerHTML = recommended.map(category => `
                <div class="recommendation-item" onclick="startCategoryTest('${category.name}')">
                    <div class="recommendation-header">
                        <span class="recommendation-name">${category.display}</span>
                        <span class="recommendation-badge">Рекомендуется</span>
                    </div>
                    <div class="recommendation-description">${category.description}</div>
                </div>
            `).join('');
        }

        function showProfileError() {
            const name = document.getElementById('profile-name');
            const resultsContainer = document.getElementById('profile-results');
            
            name.textContent = 'Ошибка загрузки';
            resultsContainer.innerHTML = `
                <div class="profile-empty-state">
                    <div class="profile-empty-icon">❌</div>
                    <div class="profile-empty-text">Не удалось загрузить данные профиля</div>
                    <button class="profile-action-btn" onclick="loadProfile();">
                        Попробовать снова
                    </button>
                </div>
            `;
        }

        // Load functions for new sections
        async function loadQuizCategories() {
            console.log('Loading quiz categories...');
            try {
                // Load modules structure with subcategories support
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/modules`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                console.log('API response:', response.ok, data);
                
                // API returns modules directly as array, not nested in data.modules
                const modules = Array.isArray(data) ? data : (data.modules || []);
                
                if (response.ok && modules.length > 0) {
                    // Find categories container - prioritize visible ones
                    let container = document.getElementById('modules-grid');
                    console.log('modules-grid container:', !!container);
                    if (!container || container.closest('.hidden')) {
                        container = document.getElementById('categories-grid');
                        console.log('categories-grid container:', !!container);
                    }
                    if (!container || container.closest('.hidden')) {
                        container = document.querySelector('.skills-grid');
                        console.log('.skills-grid container:', !!container);
                    }
                    
                    console.log('Final container found:', !!container, container && container.id);
                    
                    if (container) {
                        // Clear loading message
                        container.innerHTML = '';
                        
                        // Use modules from the corrected data above
                        console.log('Modules loaded:', modules.length);
                        console.log('Modules data:', modules);
                        
                        // Debug each module's topics  
                        modules.forEach(module => {
                            console.log(`Module ${module.name}:`, {
                                topics: module.topics,
                                total_questions: module.total_questions
                            });
                            if (module.topics) {
                                module.topics.forEach(sub => {
                                    console.log(`  Subcategory ${sub.name}:`, {
                                        total_questions: sub.total_questions,
                                        answered: sub.answered,
                                        score: sub.score
                                    });
                                });
                            }
                        });
                        
                        // Calculate progress for each module using completion_percentage from API
                        const moduleRows = modules.map(module => {
                            const totalSubcategories = module.topics ? module.topics.length : (module.submodules ? module.submodules.length : 1);
                            
                            // Use completion_percentage from API if available, otherwise calculate
                            let progressPercentage = module.completion_percentage || 0;
                            
                            // Fallback calculation if completion_percentage not available
                            if (progressPercentage === 0 && module.topics) {
                                let totalQuestions = 0;
                                let answeredQuestions = 0;
                                
                                module.topics.forEach(sub => {
                                    totalQuestions += sub.questions_count || sub.total_questions || 10;
                                    answeredQuestions += sub.answered || 0;
                                });
                                
                                progressPercentage = totalQuestions > 0 ? 
                                    Math.round((answeredQuestions / totalQuestions) * 100) : 0;
                            }
                            
                            const isPremiumLocked = module.is_premium && !module.accessible;
                            const clickHandler = isPremiumLocked ? `showPremiumPurchaseModal({id: '${module.id}', name: '${module.name}', emoji: '${module.emoji || module.icon || '📚'}', description: 'Доступ к модулю ${module.name}'})` : `showCategorySubcategories('${module.id}')`;
                            
                            // Check if progress is 100% for special styling
                            const isCompleted = progressPercentage >= 100;
                            const progressClass = isCompleted ? 'completed' : '';
                            
                            return `
                                <div class="module-row ${isPremiumLocked ? 'premium-locked' : ''}" onclick="${clickHandler}">
                                    <div class="module-info">
                                        <div class="module-icon-table">${module.emoji || module.icon || '📚'}</div>
                                        <div class="module-name">${module.name || 'Модуль'} ${isPremiumLocked ? '🔒' : ''}</div>
                                        ${isPremiumLocked ? '<div class="premium-badge-small">Premium</div>' : ''}
                                    </div>
                                    <div class="subcategories-count">${totalSubcategories} ${totalSubcategories === 1 ? 'раздел' : totalSubcategories < 5 ? 'раздела' : 'разделов'}</div>
                                    <div class="module-progress">
                                        <div class="progress-percentage ${progressClass}">${progressPercentage}%</div>
                                        <div class="progress-bar-mini">
                                            <div class="progress-fill-mini ${progressClass}" style="width: ${progressPercentage}%"></div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        const moduleTable = `
                            <div class="modules-table">
                                <div class="modules-table-header">
                                    <div>Модуль</div>
                                    <div>Разделы</div>
                                    <div>%</div>
                                </div>
                                ${moduleRows}
                            </div>
                        `;
                        
                        container.innerHTML = moduleTable;
                        
                        // Store modules data for navigation
                        window.modulesData = {};
                        modules.forEach(module => {
                            window.modulesData[module.id] = module;
                        });
                        
                        console.log('Categories loaded successfully:', modules.length);
                    } else {
                        console.error('Categories container not found!');
                    }
                } else {
                    console.log('No modules data, falling back to legacy categories');
                    await loadLegacyCategories();
                }
            } catch (error) {
                console.error('Failed to load modules:', error);
                // Fallback to old categories
                await loadLegacyCategories();
            }
        }

        async function loadLegacyCategories() {
            try {
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/categories`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('modules-view').classList.add('hidden');
                    document.getElementById('quiz-categories').classList.remove('hidden');
                    
                    const container = document.getElementById('quiz-categories');
                    container.innerHTML = data.categories.map(category => `
                        <div class="skill-card" onclick="startQuiz('${category.id}')">
                            <div class="skill-icon-container ${category.level}">
                                ${category.icon}
                            </div>
                            <div class="skill-title">${category.name}</div>
                            <div class="skill-level ${category.level}">${category.level_text}</div>
                            <div class="skill-progress-container">
                                <div class="skill-progress-label">${category.score}% правильных ответов</div>
                                <div class="skill-progress-bar">
                                    <div class="skill-progress-fill ${category.level}" style="width: ${category.score}%"></div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load legacy categories:', error);
            }
        }

        function showCategorySubcategories(categoryId) {
            const category = window.modulesData[categoryId];
            if (!category) return;
            
            console.log('Showing subcategories for category:', categoryId, category);
            
            // Switch to level test screen and show subcategories
            showScreen('level-test');
            
            // Update header
            const header = document.querySelector('#level-test-screen .header');
            if (header) {
                header.innerHTML = `
                    <h1>${category.emoji || category.icon || '📚'} ${category.name}</h1>
                    <p>${category.description}</p>
                    <button class="btn btn-outline" onclick="showScreen('tasks'); loadQuizCategories();" style="margin-top: 12px;">
                        ← Назад к категориям
                    </button>
                `;
            }
            
            // Find the skills grid container
            const container = document.getElementById('categories-grid');
            if (!container) {
                console.error('Categories grid container not found');
                return;
            }
            
            // Show subcategories or fallback message
            if (category.topics && category.topics.length > 0) {
                const subcategoryCards = category.topics.map(submodule => {
                    // Debug: log submodule data to console
                    console.log('Submodule data:', submodule.name, 'Score:', submodule.score, 'Answered:', submodule.answered, 'Total:', submodule.total_questions);
                    
                    const hasAnswers = submodule.answered > 0;
                    const allQuestionsAnswered = submodule.answered >= (submodule.questions_count || submodule.total_questions || 10);
                    const perfectScore = submodule.score >= 100;
                    
                    let statusClass, completionIcon, levelText;
                    
                    if (allQuestionsAnswered && perfectScore) {
                        // Все вопросы отвечены и все правильно (100% балл)
                        statusClass = 'completed';
                        completionIcon = ' ✅';
                        levelText = 'Пройдено';
                    } else if (hasAnswers) {
                        // Есть ответы, но либо не все вопросы, либо не 100% балл
                        statusClass = 'partial';
                        completionIcon = ' ⚠️';
                        levelText = `${submodule.answered}/${submodule.total_questions} вопросов`;
                    } else {
                        // Вообще нет ответов
                        statusClass = 'not-started';
                        completionIcon = '';
                        levelText = (submodule.difficulty || 'Mixed') + ' уровень';
                    }
                    
                    console.log('Status:', {allQuestionsAnswered, perfectScore, hasAnswers, statusClass, levelText});
                    
                    return `
                    <div class="skill-card ${statusClass}" onclick="startSubcategoryQuiz('${categoryId}', '${submodule.name}')">
                        <div class="skill-icon-container ${statusClass}">
                            ${submodule.icon || '🎯'}
                        </div>
                        <div class="skill-title">${submodule.name}${completionIcon}</div>
                        <div class="skill-level ${statusClass}">
                            ${levelText}
                        </div>
                        <div class="skill-progress-container">
                            <div class="skill-progress-label">${submodule.questions_count || submodule.total_questions || 15} вопросов</div>
                            <div class="skill-progress-bar">
                                <div class="skill-progress-fill ${statusClass}" style="width: ${submodule.score || 0}%"></div>
                            </div>
                        </div>
                        ${allQuestionsAnswered && perfectScore ? '<div class="completion-badge">✅ Завершено</div>' : ''}
                        ${hasAnswers && !(allQuestionsAnswered && perfectScore) ? '<div class="partial-badge">Частично</div>' : ''}
                    </div>
                `;
                }).join('');
                
                container.innerHTML = subcategoryCards;
            } else {
                // No subcategories, show general questions card
                container.innerHTML = `
                    <div class="skill-card" onclick="startCategoryQuiz('${categoryId}')">
                        <div class="skill-icon-container not-started">
                            🎯
                        </div>
                        <div class="skill-title">Общие вопросы</div>
                        <div class="skill-level not-started">
                            Все вопросы по ${category.name}
                        </div>
                        <div class="skill-progress-container">
                            <div class="skill-progress-label">${category.total_questions || 0} вопросов</div>
                            <div class="skill-progress-bar">
                                <div class="skill-progress-fill not-started" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        async function startSubcategoryQuiz(categoryId, subcategoryName) {
            console.log('Starting subcategory quiz:', categoryId, subcategoryName);
            
            try {
                // Load questions for specific subcategory
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/subcategory/${encodeURIComponent(categoryId)}/${encodeURIComponent(subcategoryName)}/questions`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (response.ok && data.questions && data.questions.length > 0) {
                    // Start quiz with subcategory questions
                    window.currentQuiz = {
                        questions: data.questions,
                        currentIndex: 0,
                        score: 0,
                        category: categoryId,
                        subcategory: subcategoryName
                    };
                    
                    // Initialize quiz variables
                    currentCategory = categoryId;
                    currentSubcategory = subcategoryName;
                    currentQuestions = data.questions;
                    currentQuestionIndex = 0;
                    answered = false;
                    window.userAnswers = {};
                    
                    // Switch to quiz screen and start
                    showScreen('quiz');
                    displayQuestion();
                } else {
                    alert(`Вопросы для подкатегории "${subcategoryName}" пока не добавлены.\nПопробуйте другую подкатегорию или обратитесь к администратору.`);
                }
            } catch (error) {
                console.error('Error loading subcategory questions:', error);
                alert('Ошибка загрузки вопросов. Попробуйте позже.');
            }
        }

        async function startCategoryQuiz(categoryId) {
            console.log('Starting category quiz:', categoryId);
            
            try {
                // Convert module ID to category name
                const modulesResponse = await fetch('/api/modules');
                const modules = await modulesResponse.json();
                const module = modules.find(m => m.id == categoryId);
                
                if (!module) {
                    alert('Модуль не найден');
                    return;
                }
                
                const categoryName = module.name;
                
                // For computer_vision, use the available subcategory
                if (categoryName === 'computer_vision') {
                    // Use the actual subcategory from database
                    startSubcategoryQuiz(categoryName, 'Обработка изображений');
                    return;
                }
                
                // For other categories, map to their default subcategories
                if (categoryName === 'machine_learning') {
                    startSubcategoryQuiz(categoryName, 'Алгоритмы классификации');
                    return;
                } else if (categoryName === 'nlp') {
                    startSubcategoryQuiz(categoryName, 'Обработка текста');
                    return;
                } else if (categoryName === 'python') {
                    startSubcategoryQuiz(categoryName, 'Основы синтаксиса');
                    return;
                } else if (categoryName === 'screening_test') {
                    startSubcategoryQuiz(categoryName, 'Тест');
                    return;
                }
                
                // Legacy fallback - try to load all questions for category
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/questions/${encodeURIComponent(categoryId)}`;
                const categoryResponse = await fetch(apiUrl);
                const data = await categoryResponse.json();
                
                if (categoryResponse.ok && data.questions && data.questions.length > 0) {
                    // Start quiz with category questions
                    window.currentQuiz = {
                        questions: data.questions,
                        currentIndex: 0,
                        score: 0,
                        category: categoryId
                    };
                    
                    // Initialize quiz variables
                    currentCategory = categoryId;
                    currentSubcategory = null; // No subcategory for direct category quiz
                    currentQuestions = data.questions;
                    currentQuestionIndex = 0;
                    answered = false;
                    window.userAnswers = {};
                    
                    // Switch to quiz screen and start
                    showScreen('quiz');
                    displayQuestion();
                } else {
                    alert(`Вопросы для категории "${categoryId}" пока не добавлены.\nОбратитесь к администратору.`);
                }
            } catch (error) {
                console.error('Error loading category questions:', error);
                alert('Ошибка загрузки вопросов. Попробуйте позже.');
            }
        }

        // Remove old navigation functions as they're no longer needed
        // Navigation now handled by showScreen() function

        async function startTopicQuiz(moduleId, topicId) {
            const module = window.modulesData[moduleId];
            const topic = module.topics[topicId];
            
            try {
                // Load questions for the module (using category name)
                const response = await fetch(`/api/questions/${encodeURIComponent(moduleId)}`);
                const data = await response.json();
                
                if (response.ok && data.questions && data.questions.length > 0) {
                    // Start quiz with real questions
                    window.currentQuiz = {
                        questions: data.questions,
                        currentIndex: 0,
                        score: 0,
                        category: moduleId,
                        topic: topicId
                    };
                    
                    // Switch to quiz screen and start the quiz
                    showScreen('quiz');
                    startQuiz(moduleId);
                } else {
                    alert(`Вопросы для темы "${topic.name}" пока не добавлены.\nПопробуйте другую тему или обратитесь к администратору.`);
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Ошибка загрузки вопросов. Попробуйте позже.');
            }
        }

        function showBottomNavigation() {
            const bottomNav = document.querySelector('.bottom-navigation');
            if (bottomNav) {
                bottomNav.classList.add('visible');
            }
        }
        
        // Function to start screening test
        async function startScreeningTest() {
            // Track screening test start
            trackTestEvent('start', 'screening_test', { questions_count: 10 });
            trackPageView('Скрининговый тест');
            
            try {
                // Start the screening test using the standard API
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/subcategory/screening_test/Общая оценка/questions`;
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.questions && data.questions.length > 0) {
                    currentCategory = 'screening_test';
                    currentSubcategory = 'Общая оценка';
                    currentQuestions = data.questions;
                    currentQuestionIndex = 0;
                    answered = false;
                    window.userAnswers = {};
                    
                    // Initialize quiz progress for screening test
                    quizProgress = {
                        category: 'screening_test',
                        subcategory: 'Общая оценка', 
                        questions: data.questions,
                        currentIndex: 0,
                        answers: {},
                        started: true
                    };
                    
                    showScreen('quiz');
                    showBottomNavigation(); // Show navigation for test
                    displayQuestion();
                    saveQuizProgress();
                } else {
                    console.error('No screening questions received');
                    alert('Не удалось загрузить скрининговый тест');
                    // Fallback to regular home screen
                    showScreen('home');
                    showBottomNavigation();
                    loadCategories();
                    loadProgress();
                }
            } catch (error) {
                console.error('Failed to load screening test:', error);
                alert('Ошибка загрузки скринингового теста');
                // Fallback to regular home screen
                showScreen('home');
                showBottomNavigation();
                loadCategories();
                loadProgress();
            }
        }
        
        // Function to show all topics (placeholder for future implementation)
        function showAllTopics() {
            // For now, just show the home screen with all categories
            showScreen('home');
            showBottomNavigation();
            loadCategories();
            loadProgress();
        }

        function hideBottomNavigation() {
            const bottomNav = document.querySelector('.bottom-navigation');
            if (bottomNav) {
                bottomNav.classList.remove('visible');
            }
        }

        async function loadLeaderboard() {
            try {
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/leaderboard`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (response.ok) {
                    const container = document.getElementById('leaderboard-content');
                    container.innerHTML = `
                        <div class="leaderboard-list">
                            ${data.leaderboard.map((user, index) => `
                                <div class="leaderboard-item">
                                    <div class="rank">#${index + 1}</div>
                                    <div class="user-info">
                                        <div class="username">${user.name || 'Пользователь'}</div>
                                        <div class="score">${Math.round(user.score)}% • ${user.level}</div>
                                    </div>
                                    <div class="badge">${user.total_answered}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
            }
        }

        async function loadProfile() {
            try {
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/profile`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (response.ok) {
                    const container = document.getElementById('profile-content');
                    container.innerHTML = `
                        <div class="profile-card">
                            <div class="profile-avatar">👤</div>
                            <h3>${data.name || 'Пользователь'}</h3>
                            <div class="profile-stats">
                                <div class="profile-stat">
                                    <div class="stat-value">${data.total_answered}</div>
                                    <div class="stat-label">Вопросов отвечено</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="stat-value">${Math.round(data.overall_score)}%</div>
                                    <div class="stat-label">Средний балл</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="stat-value">${data.level}</div>
                                    <div class="stat-label">Текущий уровень</div>
                                </div>
                            </div>
                            
                            <!-- Contact button -->
                            <div class="contact-section" style="margin-top: 20px;">
                                <a href="https://t.me/AI_bolno_ml" target="_blank" class="contact-button" onclick="trackEvent('contact_click', {source: 'profile'})">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-.14.06-.24.11-.14.07-1.74 1.1-4.91 3.23-.46.31-.88.46-1.26.45-.42-.01-1.22-.24-1.82-.43-.73-.24-1.31-.37-1.26-.78.03-.21.36-.43.98-.65 3.84-1.67 6.4-2.77 7.69-3.31 3.66-1.55 4.42-1.82 4.91-1.83.11 0 .35.03.51.17.13.12.17.28.19.39-.01.09.01.33-.02.53z" fill="currentColor"/>
                                    </svg>
                                    Связаться с автором
                                </a>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        function loadKnowledgeBase() {
            // Knowledge base is static HTML, no loading needed
            console.log('Knowledge base loaded');
        }

        function openKnowledgeCategory(category) {
            alert(`Раздел "${category}" в разработке. Скоро здесь будут полезные материалы!`);
        }

        // Check if it's a Telegram Mini App on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if running inside Telegram
            const isInTelegram = window.Telegram && window.Telegram.WebApp;
            
            // Debug Telegram WebApp data
            if (isInTelegram) {
                console.log('Telegram WebApp object:', window.Telegram.WebApp);
                console.log('initData:', window.Telegram.WebApp.initData);
                console.log('initDataUnsafe:', window.Telegram.WebApp.initDataUnsafe);
            }
            
            // Check for auto-authentication
            if (isInTelegram) {
                // Wait a bit for Telegram WebApp to initialize
                setTimeout(async () => {
                    const tgApp = window.Telegram.WebApp;
                    let hasUserData = false;
                    
                    // Check if we have user data
                    if (tgApp.initDataUnsafe && tgApp.initDataUnsafe.user) {
                        hasUserData = true;
                    } else if (tgApp.initData) {
                        try {
                            const urlParams = new URLSearchParams(tgApp.initData);
                            const userParam = urlParams.get('user');
                            if (userParam) {
                                hasUserData = true;
                            }
                        } catch (e) {
                            // Ignore parsing errors
                        }
                    }
                    
                    if (hasUserData) {
                        console.log('Auto-authenticating with Telegram data...');
                        await authenticateUser();
                    } else {
                        console.log('No Telegram user data, showing auth screen');
                        document.getElementById('auth-screen').style.display = 'block';
                        document.getElementById('home-screen').classList.add('hidden');
                        showTelegramValidationStatus();
                    }
                }, 500);
            } else {
                // Always show auth screen first - no auto-login
                console.log('Not in Telegram, showing authentication screen');
                document.getElementById('auth-screen').style.display = 'block';
                document.getElementById('home-screen').classList.add('hidden');
            }
            
            // Show validation status after a delay
            setTimeout(showTelegramValidationStatus, 1000);
        });

        // Initialize navigation and load stats
        initNavigation();
        loadStatsOverview();

        // Premium modal functions
        function showPremiumModal(moduleName) {
            const modal = document.getElementById('premium-modal');
            if (modal) {
                modal.classList.remove('hidden');
                
                // Update modal title with specific module
                const subtitle = modal.querySelector('.premium-subtitle');
                if (subtitle && moduleName) {
                    subtitle.textContent = `Для доступа к модулю "${moduleName}" нужен Premium`;
                }
            }
        }

        function closePremiumModal() {
            const modal = document.getElementById('premium-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        async function purchasePremium() {
            try {
                console.log('Initiating premium purchase...');
                
                // Create invoice
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/create_invoice`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (response.ok && data.invoice) {
                    console.log('Invoice created:', data.invoice);
                    
                    // Check if Telegram WebApp is available
                    if (window.Telegram && window.Telegram.WebApp) {
                        // Use Telegram Payments API
                        try {
                            window.Telegram.WebApp.openInvoice(data.invoice.payload, (status) => {
                                console.log('Payment status:', status);
                                if (status === 'paid') {
                                    processPremiumPayment();
                                } else if (status === 'cancelled') {
                                    console.log('Payment cancelled by user');
                                } else if (status === 'failed') {
                                    console.log('Payment failed');
                                    alert('Ошибка при оплате. Попробуйте еще раз.');
                                }
                            });
                        } catch (telegramError) {
                            console.error('Telegram payment error:', telegramError);
                            // Fallback: simulate successful payment for demo
                            if (confirm('Демо режим: Активировать Premium доступ?')) {
                                processPremiumPayment();
                            }
                        }
                    } else {
                        console.log('Telegram WebApp not available, using demo mode');
                        // Demo mode: ask user to confirm
                        if (confirm('Демо режим: Активировать Premium доступ за 499₽?')) {
                            processPremiumPayment();
                        }
                    }
                } else {
                    console.error('Failed to create invoice:', data);
                    alert('Ошибка создания счета. Попробуйте позже.');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                alert('Ошибка при покупке. Попробуйте позже.');
            }
        }

        async function processPremiumPayment() {
            try {
                console.log('Processing premium payment...');
                
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/process_payment`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    console.log('Premium access granted!');
                    
                    // Close modal
                    closePremiumModal();
                    
                    // Show success message
                    alert('🎉 Premium доступ активирован! Теперь вам доступны все модули.');
                    
                    // Reload modules to show unlocked content
                    await loadQuizCategories();
                    
                } else {
                    console.error('Payment processing failed:', data);
                    alert('Ошибка при активации Premium. Обратитесь в поддержку.');
                }
            } catch (error) {
                console.error('Payment processing error:', error);
                alert('Ошибка при обработке платежа.');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('premium-modal');
            if (modal && event.target === modal) {
                closePremiumModal();
            }
        });

        // Module search functionality
        function filterModules(searchTerm) {
            const searchInput = document.getElementById('module-search');
            const clearButton = document.getElementById('clear-search');
            const modulesGrid = document.getElementById('modules-grid');
            
            // Show/hide clear button
            if (searchTerm.trim()) {
                clearButton.style.display = 'flex';
            } else {
                clearButton.style.display = 'none';
            }
            
            // Get all module rows (correct selector for the current structure)
            const moduleRows = modulesGrid.querySelectorAll('.module-row');
            let visibleCount = 0;
            
            searchTerm = searchTerm.toLowerCase().trim();
            
            moduleRows.forEach(row => {
                // Get module name from the row
                const nameElement = row.querySelector('.module-name');
                
                if (!nameElement) return;
                
                const moduleName = nameElement.textContent.toLowerCase();
                
                // Remove lock and premium indicators from search
                const cleanModuleName = moduleName.replace(/🔒/g, '').replace(/premium/gi, '').trim();
                
                // Check if search term matches module name
                const matches = !searchTerm || cleanModuleName.includes(searchTerm) || moduleName.includes(searchTerm);
                
                if (matches) {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    row.classList.add('hidden');
                }
            });
            
            // Show "No results" message if no modules match
            showNoResultsMessage(visibleCount === 0 && searchTerm);
            
            console.log(`Search: "${searchTerm}" - ${visibleCount} modules visible`);
        }

        function clearSearch() {
            const searchInput = document.getElementById('module-search');
            const clearButton = document.getElementById('clear-search');
            
            searchInput.value = '';
            clearButton.style.display = 'none';
            
            // Show all modules
            filterModules('');
            
            // Focus back on search input
            searchInput.focus();
        }

        function showNoResultsMessage(show) {
            const modulesGrid = document.getElementById('modules-grid');
            let noResultsDiv = modulesGrid.querySelector('.no-results');
            
            if (show) {
                if (!noResultsDiv) {
                    noResultsDiv = document.createElement('div');
                    noResultsDiv.className = 'no-results';
                    noResultsDiv.innerHTML = `
                        <div class="no-results-icon">🔍</div>
                        <h3>Модули не найдены</h3>
                        <p>Попробуйте изменить поисковый запрос<br>или очистите фильтр</p>
                    `;
                    modulesGrid.appendChild(noResultsDiv);
                }
            } else {
                if (noResultsDiv) {
                    noResultsDiv.remove();
                }
            }
        }

        // Add keyboard shortcuts for search
        document.addEventListener('keydown', function(event) {
            // Ctrl/Cmd + K to focus search
            if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                event.preventDefault();
                const searchInput = document.getElementById('module-search');
                if (searchInput && document.getElementById('tasks-screen').style.display !== 'none') {
                    searchInput.focus();
                    searchInput.select();
                }
            }
            
            // Escape to clear search
            if (event.key === 'Escape') {
                const searchInput = document.getElementById('module-search');
                if (searchInput && document.activeElement === searchInput) {
                    clearSearch();
                }
            }
        });

        // Premium module functions
        async function checkModuleAccess(moduleName) {
            try {
                const response = await fetch(`/api/check_module_access/${moduleName}`);
                if (!response.ok) return false;
                
                const data = await response.json();
                return data.has_access;
            } catch (error) {
                console.error('Error checking module access:', error);
                return false;
            }
        }

        // Show premium purchase modal
        function showPremiumPurchaseModal(module) {
            // Remove existing modal if present
            const existingModal = document.querySelector('.premium-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'premium-modal';
            modal.innerHTML = `
                <div class="premium-modal-content">
                    <div class="premium-header">
                        <div class="premium-icon">💎</div>
                        <h3>Премиум модуль</h3>
                        <button class="modal-close" onclick="closePremiumModal()">&times;</button>
                    </div>
                    
                    <div class="premium-body">
                        <div class="module-info-premium">
                            <div class="module-icon-large">${module.emoji}</div>
                            <h4>${module.name}</h4>
                            <p>${module.description}</p>
                        </div>
                        
                        <div class="premium-features">
                            <div class="feature-item">
                                <div class="feature-icon">✅</div>
                                <span>Доступ ко всем вопросам модуля</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">✅</div>
                                <span>Подробные объяснения от ИИ</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">✅</div>
                                <span>Персональные рекомендации</span>
                            </div>
                        </div>
                        
                        <div class="price-section">
                            <div class="price-text">Цена: <span class="price-amount" id="module-price">299 ₽</span></div>
                        </div>
                    </div>
                    
                    <div class="premium-footer">
                        <button class="btn-cancel" onclick="closePremiumModal()">Отмена</button>
                        <button class="btn-purchase" onclick="purchaseModule('${module.id}')">
                            💳 Купить модуль
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add CSS styles for premium modal
            if (!document.getElementById('premium-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'premium-modal-styles';
                styles.textContent = `
                    .premium-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                        backdrop-filter: blur(5px);
                        animation: modalFadeIn 0.3s ease-out;
                    }
                    
                    .premium-modal-content {
                        background: linear-gradient(135deg, #ffffff, #f8f8f8);
                        border-radius: 20px;
                        max-width: 400px;
                        width: 90%;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        border: 2px solid #FF6B35;
                        overflow: hidden;
                        animation: modalSlideUp 0.3s ease-out;
                    }
                    
                    .premium-header {
                        background: linear-gradient(135deg, #FF6B35, #FF8C42);
                        color: white;
                        padding: 20px;
                        text-align: center;
                        position: relative;
                    }
                    
                    .premium-icon {
                        font-size: 32px;
                        margin-bottom: 8px;
                    }
                    
                    .premium-header h3 {
                        margin: 0;
                        font-size: 20px;
                        font-weight: 600;
                    }
                    
                    .modal-close {
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: none;
                        border: none;
                        color: white;
                        font-size: 24px;
                        cursor: pointer;
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: background-color 0.2s;
                    }
                    
                    .modal-close:hover {
                        background: rgba(255, 255, 255, 0.2);
                    }
                    
                    .premium-body {
                        padding: 24px;
                    }
                    
                    .module-info-premium {
                        text-align: center;
                        margin-bottom: 24px;
                    }
                    
                    .module-icon-large {
                        font-size: 48px;
                        margin-bottom: 12px;
                    }
                    
                    .module-info-premium h4 {
                        margin: 0 0 8px 0;
                        font-size: 24px;
                        color: #333;
                    }
                    
                    .module-info-premium p {
                        margin: 0;
                        color: #666;
                        font-size: 16px;
                    }
                    
                    .premium-features {
                        margin-bottom: 24px;
                    }
                    
                    .feature-item {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        margin-bottom: 12px;
                    }
                    
                    .feature-icon {
                        font-size: 16px;
                        color: #28a745;
                    }
                    
                    .feature-item span {
                        font-size: 14px;
                        color: #333;
                    }
                    
                    .price-section {
                        background: #f8f9fa;
                        padding: 16px;
                        border-radius: 12px;
                        text-align: center;
                        margin-bottom: 24px;
                    }
                    
                    .price-text {
                        font-size: 18px;
                        color: #333;
                        font-weight: 500;
                    }
                    
                    .price-amount {
                        font-size: 24px;
                        color: #FF6B35;
                        font-weight: 700;
                    }
                    
                    .premium-footer {
                        padding: 0 24px 24px;
                        display: flex;
                        gap: 12px;
                    }
                    
                    .btn-cancel, .btn-purchase {
                        flex: 1;
                        padding: 12px 20px;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                        border: none;
                    }
                    
                    .btn-cancel {
                        background: #f8f9fa;
                        color: #666;
                        border: 1px solid #e9ecef;
                    }
                    
                    .btn-cancel:hover {
                        background: #e9ecef;
                    }
                    
                    .btn-purchase {
                        background: linear-gradient(135deg, #FF6B35, #FF8C42);
                        color: white;
                        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
                    }
                    
                    .btn-purchase:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4);
                    }
                    
                    .premium-badge-small {
                        font-size: 10px;
                        background: linear-gradient(135deg, #FF6B35, #FF8C42);
                        color: white;
                        padding: 2px 6px;
                        border-radius: 8px;
                        margin-left: 8px;
                        font-weight: 600;
                    }
                    
                    .module-row.premium-locked {
                        opacity: 0.7;
                        cursor: pointer;
                        transition: opacity 0.2s;
                    }
                    
                    .module-row.premium-locked:hover {
                        opacity: 1;
                    }
                    
                    @keyframes modalFadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes modalSlideUp {
                        from { 
                            transform: translateY(50px);
                            opacity: 0;
                        }
                        to { 
                            transform: translateY(0);
                            opacity: 1;
                        }
                    }
                    
                    /* Notification styles */
                    .success-notification, .error-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
                        z-index: 10001;
                        animation: notificationSlideIn 0.3s ease-out;
                        min-width: 300px;
                        max-width: 400px;
                    }
                    
                    .success-notification {
                        border-left: 4px solid #28a745;
                    }
                    
                    .error-notification {
                        border-left: 4px solid #dc3545;
                    }
                    
                    .notification-content {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 16px 20px;
                    }
                    
                    .notification-icon {
                        font-size: 20px;
                    }
                    
                    .notification-text {
                        font-size: 14px;
                        font-weight: 500;
                        color: #333;
                        flex: 1;
                    }
                    
                    @keyframes notificationSlideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(styles);
            }
        }

        // Close premium modal
        function closePremiumModal() {
            const modal = document.querySelector('.premium-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Purchase module
        async function purchaseModule(moduleId) {
            try {
                console.log('Purchasing module:', moduleId);
                
                const response = await fetch('/api/purchase_module', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        module_name: moduleId
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    if (result.test_mode) {
                        // Test mode - show success message
                        closePremiumModal();
                        showSuccessNotification('Модуль успешно приобретен! (тестовый режим)');
                        // Reload to reflect the change
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        // Real payment - redirect to Telegram payment
                        if (result.payment_url) {
                            window.open(result.payment_url, '_blank');
                        }
                    }
                } else {
                    showErrorNotification(result.error || 'Ошибка при покупке модуля');
                }
            } catch (error) {
                console.error('Error purchasing module:', error);
                showErrorNotification('Ошибка при покупке модуля');
            }
        }

        // Show success notification
        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">✅</div>
                    <div class="notification-text">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Show error notification
        function showErrorNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'error-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">❌</div>
                    <div class="notification-text">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
        
    </script>
    <!-- Premium Modal -->
    <div id="premium-modal" class="premium-modal hidden">
        <div class="premium-modal-content">
            <div class="premium-icon">💎</div>
            <h2 class="premium-title">Premium доступ</h2>
            <p class="premium-subtitle">Разблокируйте все модули обучения</p>
            
            <div class="premium-features">
                <div class="premium-feature">
                    <span>🤖</span>
                    <span>Machine Learning курс</span>
                </div>
                <div class="premium-feature">
                    <span>💬</span>
                    <span>NLP и обработка текста</span>
                </div>
                <div class="premium-feature">
                    <span>👁️</span>
                    <span>Computer Vision</span>
                </div>
                <div class="premium-feature">
                    <span>🧠</span>
                    <span>Deep Learning</span>
                </div>
                <div class="premium-feature">
                    <span>📊</span>
                    <span>Data Science</span>
                </div>
                <div class="premium-feature">
                    <span>⚡</span>
                    <span>Алгоритмы</span>
                </div>
            </div>
            
            <div class="premium-price">499 ₽</div>
            
            <button class="btn-premium" onclick="purchasePremium()">
                Купить Premium
            </button>
            <button class="btn-close-modal" onclick="closePremiumModal()">
                Может позже
            </button>
        </div>
    </div>

</body>
</html>